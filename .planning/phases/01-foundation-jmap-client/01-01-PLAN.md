---
phase: 01-foundation-jmap-client
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - vitest.config.ts
  - src/config/schema.ts
  - src/config/logger.ts
  - src/errors.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "npm install completes without errors"
    - "npm run build compiles TypeScript to ESM in build/"
    - "Invalid environment variables cause immediate exit with clear error message"
    - "Logger writes only to stderr, never stdout"
    - "HTTP URLs (except localhost) are rejected by config validation"
  artifacts:
    - path: "package.json"
      provides: "ESM package with type:module, scripts, dependencies"
      contains: '"type": "module"'
    - path: "tsconfig.json"
      provides: "TypeScript config with Node16 resolution"
      contains: '"moduleResolution": "Node16"'
    - path: "src/config/schema.ts"
      provides: "Zod schema for environment validation"
      exports: ["envSchema", "Config", "loadConfig"]
    - path: "src/config/logger.ts"
      provides: "Pino logger factory"
      exports: ["createLogger", "Logger"]
    - path: "src/errors.ts"
      provides: "AI-friendly error formatting"
      exports: ["formatStartupError", "JMAPError"]
  key_links:
    - from: "src/index.ts"
      to: "src/config/schema.ts"
      via: "loadConfig import"
      pattern: "import.*loadConfig.*from.*config/schema"
    - from: "src/index.ts"
      to: "src/config/logger.ts"
      via: "createLogger import"
      pattern: "import.*createLogger.*from.*config/logger"
---

<objective>
Establish TypeScript ESM project infrastructure with fail-fast configuration validation and stderr-only logging.

Purpose: This is the foundation for all subsequent development. Without proper ESM setup, config validation, and logging, the JMAP client cannot be built safely.

Output: A buildable TypeScript project with Zod-validated config, Pino logger, and AI-friendly error formatting.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-jmap-client/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize TypeScript ESM project</name>
  <files>package.json, tsconfig.json, vitest.config.ts</files>
  <action>
Create package.json with:
- "name": "mcp-twake-mail"
- "version": "0.1.0"
- "type": "module" (CRITICAL for ESM)
- "main": "./build/index.js"
- "bin": { "mcp-twake-mail": "./build/index.js" }
- "engines": { "node": ">=20.0.0" }
- Scripts: build (tsc), start (node build/index.js), dev (tsc --watch), test (vitest run), test:watch (vitest)
- Dependencies: @modelcontextprotocol/sdk ^1.25.3, zod ^4.3.6, pino ^10.3.0
- DevDependencies: typescript ^5.9.0, @types/node ^25.0.10, vitest ^4.0.18, vitest-fetch-mock ^0.4.0

Create tsconfig.json with:
- target: "ES2022"
- module: "Node16"
- moduleResolution: "Node16" (CRITICAL for stable ESM)
- outDir: "./build"
- rootDir: "./src"
- strict: true
- esModuleInterop: true
- skipLibCheck: true
- declaration: true
- sourceMap: true
- include: ["src/**/*"]
- exclude: ["node_modules", "build"]

Create vitest.config.ts with:
- defineConfig from vitest/config
- test.globals: true
- test.environment: "node"

Run npm install to create node_modules and package-lock.json.
  </action>
  <verify>
npm run build succeeds with no errors.
ls build/ shows index.js exists (will be empty/stub for now).
  </verify>
  <done>
TypeScript compiles to ESM output in build/ directory without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create config validation and logger</name>
  <files>src/config/schema.ts, src/config/logger.ts</files>
  <action>
Create src/config/schema.ts with Zod schema:
- JMAP_SESSION_URL: z.string().url() with HTTPS enforcement (allow localhost/127.0.0.1 for dev)
- JMAP_AUTH_METHOD: z.enum(['basic', 'bearer', 'oidc']).default('basic')
- JMAP_USERNAME: z.string().optional()
- JMAP_PASSWORD: z.string().optional()
- JMAP_TOKEN: z.string().optional()
- JMAP_REQUEST_TIMEOUT: z.coerce.number().default(30000) (configurable timeout in ms)
- LOG_LEVEL: z.enum(['fatal', 'error', 'warn', 'info', 'debug', 'trace']).default('info')
- Use .superRefine() for conditional validation:
  - basic auth requires JMAP_USERNAME and JMAP_PASSWORD
  - bearer/oidc auth requires JMAP_TOKEN
- Export: envSchema, Config type, loadConfig() function that calls envSchema.parse(process.env)

Create src/config/logger.ts:
- Import pino from 'pino'
- Export Logger type alias for pino.Logger
- Export createLogger(level: string = 'info') function
- CRITICAL: Use pino.destination(2) to write to stderr (fd 2), NEVER stdout
- Set name: 'mcp-twake-mail'

Follow exact patterns from 01-RESEARCH.md Pattern 1 and Pattern 2.
  </action>
  <verify>
Create a test that:
1. Sets valid env vars, calls loadConfig(), verifies Config type returned
2. Sets invalid env vars (missing JMAP_SESSION_URL), calls loadConfig(), verifies ZodError thrown
3. Calls createLogger(), writes a log, verifies output goes to stderr not stdout
  </verify>
  <done>
loadConfig() validates env vars and throws clear ZodError on invalid config.
createLogger() returns Pino logger that writes only to stderr.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create error formatting and entry point stub</name>
  <files>src/errors.ts, src/index.ts</files>
  <action>
Create src/errors.ts with:
- Import { ZodError } from 'zod'
- Export JMAPError class extending Error with:
  - type: string (e.g., 'authFailed', 'timeout', 'serverError')
  - fix: string (how to resolve)
  - Constructor: (message: string, type: string, fix: string)
- Export formatStartupError(error: Error, sessionUrl?: string): string function
  - Handle ZodError: List each issue with path and message, add fix suggestions
  - Handle 401/unauthorized: "Authentication failed" + credential check instructions
  - Handle timeout: "Connection timed out" + server accessibility check
  - Handle unknown: Generic message with config check suggestion
  - Format: "What went wrong\n\nFix: How to fix it"

Create src/index.ts entry point:
- Add shebang: #!/usr/bin/env node
- Import loadConfig from './config/schema.js'
- Import createLogger from './config/logger.js'
- Import formatStartupError from './errors.js'
- Create main() async function with try/catch:
  - Call loadConfig() (fail-fast)
  - Call createLogger(config.LOG_LEVEL)
  - Log startup message: { version: '0.1.0' }, 'Starting mcp-twake-mail server'
  - Add placeholder comment: // JMAP client initialization will be added in Plan 02
  - Catch block: format error with formatStartupError(), console.error to stderr, process.exit(1)
- Call main()

Follow exact patterns from 01-RESEARCH.md Pattern 6.
  </action>
  <verify>
npm run build succeeds.
Set valid env vars (JMAP_SESSION_URL=https://example.com, JMAP_USERNAME=test, JMAP_PASSWORD=test).
Run node build/index.js - should log startup message to stderr and exit cleanly (or hang waiting for JMAP).
Set invalid env vars (unset JMAP_SESSION_URL).
Run node build/index.js - should print formatted error message and exit with code 1.
  </verify>
  <done>
Entry point validates config at startup and exits with AI-friendly error on failure.
Build completes without TypeScript errors.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   npm run build
   # Should complete with no errors
   ls build/
   # Should show: index.js, config/, errors.js
   ```

2. **Config validation test:**
   ```bash
   # Missing required var
   unset JMAP_SESSION_URL
   node build/index.js 2>&1
   # Should show: "Configuration validation failed:" with clear error
   echo $?
   # Should be: 1
   ```

3. **Successful startup test:**
   ```bash
   export JMAP_SESSION_URL="https://jmap.linagora.com/jmap/session"
   export JMAP_USERNAME="test@example.com"
   export JMAP_PASSWORD="testpass"
   timeout 5 node build/index.js 2>&1 || true
   # Should show: "Starting mcp-twake-mail server" to stderr
   ```

4. **HTTPS enforcement test:**
   ```bash
   export JMAP_SESSION_URL="http://insecure.example.com/jmap"
   node build/index.js 2>&1
   # Should fail with: "URL must use HTTPS"
   ```
</verification>

<success_criteria>
- npm install completes successfully
- npm run build produces ESM output in build/ with no TypeScript errors
- Invalid configuration causes immediate exit with human-readable error message
- Valid configuration allows startup (will hang waiting for JMAP, that's expected)
- HTTP URLs are rejected except for localhost
- All logs go to stderr, stdout remains empty
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-jmap-client/01-01-SUMMARY.md`
</output>
