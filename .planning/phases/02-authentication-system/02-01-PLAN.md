---
phase: 02-authentication-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/schema.ts
  - src/auth/token-store.ts
  - src/errors.ts
  - src/auth/index.ts
  - tests/auth/token-store.test.ts
autonomous: true

must_haves:
  truths:
    - "OIDC configuration fields are validated at startup"
    - "Tokens can be saved to ~/.mcp-twake-mail/tokens.json"
    - "Token file has 0600 permissions (owner read/write only)"
    - "Auth errors include clear re-authentication instructions"
  artifacts:
    - path: "src/config/schema.ts"
      provides: "OIDC config validation (issuer, clientId, scope, redirectUri)"
      contains: "JMAP_OIDC_ISSUER"
    - path: "src/auth/token-store.ts"
      provides: "Token persistence with secure permissions"
      exports: ["saveTokens", "loadTokens", "clearTokens", "StoredTokens"]
    - path: "src/errors.ts"
      provides: "Auth-specific error factories"
      contains: "tokenExpired"
  key_links:
    - from: "src/config/schema.ts"
      to: "JMAP_AUTH_METHOD"
      via: "conditional OIDC field validation"
      pattern: "JMAP_AUTH_METHOD.*oidc"
    - from: "src/auth/token-store.ts"
      to: "~/.mcp-twake-mail/tokens.json"
      via: "fs.writeFile with mode 0o600"
      pattern: "mode.*0o600"
---

<objective>
Create the foundational components for OIDC authentication: extended configuration validation, secure token storage, and auth-specific error handling.

Purpose: These three components are prerequisites for all OIDC functionality. Without config validation, we can't get issuer/client details. Without token store, we can't persist tokens. Without auth errors, we can't guide users when authentication fails.

Output: Config schema extended for OIDC, token store module with 0600 permissions, auth error factories in errors.ts
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-system/02-RESEARCH.md

# Existing files to modify
@src/config/schema.ts
@src/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema for OIDC</name>
  <files>src/config/schema.ts</files>
  <action>
Add OIDC-specific environment variable fields to the Zod schema:

1. Add new fields after JMAP_TOKEN:
   - JMAP_OIDC_ISSUER: z.string().url() - The OIDC provider URL (e.g., https://auth.linagora.com)
   - JMAP_OIDC_CLIENT_ID: z.string() - OAuth2 client ID
   - JMAP_OIDC_SCOPE: z.string().default('openid email offline_access') - OAuth2 scopes (offline_access is required for refresh tokens)
   - JMAP_OIDC_REDIRECT_PORT: z.coerce.number().default(3000) - Localhost callback port

2. Update superRefine validation:
   - When JMAP_AUTH_METHOD is 'oidc', require JMAP_OIDC_ISSUER and JMAP_OIDC_CLIENT_ID
   - Remove the JMAP_TOKEN requirement for 'oidc' method (tokens come from OIDC flow)

3. Keep JMAP_TOKEN requirement for 'bearer' method only

Note: Do NOT require JMAP_TOKEN for OIDC - tokens are obtained through the OAuth flow and stored in token-store, not environment variables.
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Run `npm test` - existing config tests still pass.
  </verify>
  <done>
OIDC config fields are defined and conditionally required when auth method is 'oidc'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create token store with secure permissions</name>
  <files>src/auth/token-store.ts, src/auth/index.ts, tests/auth/token-store.test.ts</files>
  <action>
Create src/auth/token-store.ts implementing secure token persistence:

1. Define StoredTokens interface:
   ```typescript
   export interface StoredTokens {
     accessToken: string;
     refreshToken?: string;
     expiresAt?: number;  // Unix timestamp in seconds
     idToken?: string;
   }
   ```

2. Define TOKEN_PATH constant:
   ```typescript
   const TOKEN_PATH = join(homedir(), '.mcp-twake-mail', 'tokens.json');
   ```

3. Implement saveTokens(tokens: StoredTokens): Promise<void>
   - Create parent directory with mode 0o700 (recursive: true)
   - Write file with JSON.stringify(tokens, null, 2)
   - Use mode: 0o600 on writeFile
   - Call chmod(TOKEN_PATH, 0o600) after write to ensure permissions even if file existed

4. Implement loadTokens(): Promise<StoredTokens | null>
   - Try to read and parse TOKEN_PATH
   - Return null if ENOENT (file doesn't exist)
   - Re-throw other errors

5. Implement clearTokens(): Promise<void>
   - Delete TOKEN_PATH if it exists
   - Ignore ENOENT errors

6. Create src/auth/index.ts barrel export:
   ```typescript
   export * from './token-store.js';
   ```

7. Create tests/auth/token-store.test.ts:
   - Test saveTokens creates file with correct content
   - Test loadTokens returns null when no file exists
   - Test loadTokens returns tokens when file exists
   - Test clearTokens removes file
   - Test file permissions are 0600 (use fs.stat and check mode)
   - Use a temp directory for tests (vi.stubEnv or mock homedir)

Use native 'node:fs/promises', 'node:os', and 'node:path' - no external dependencies.
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Run `npm test -- tests/auth/token-store.test.ts` - all token store tests pass.
Run `ls -la ~/.mcp-twake-mail/` (after test creates file) - verify 0600 permissions on tokens.json.
  </verify>
  <done>
Token store saves/loads tokens with 0600 file permissions. Tests verify permission enforcement.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add auth-specific error factories</name>
  <files>src/errors.ts</files>
  <action>
Add static factory methods to JMAPError class for auth-specific errors:

1. Add tokenExpired(refreshAvailable: boolean): JMAPError
   - If refresh available: "Access token expired. Will attempt automatic refresh."
   - If no refresh: "Access token expired and no refresh token available. Re-authenticate using: npx mcp-twake-mail auth"
   - Type: 'tokenExpired'

2. Add refreshFailed(reason?: string): JMAPError
   - Message: "Token refresh failed" + optional reason
   - Fix: "Your session has expired. Re-authenticate using: npx mcp-twake-mail auth"
   - Type: 'refreshFailed'

3. Add oidcFlowError(stage: string, details?: string): JMAPError
   - Message: "OIDC authentication failed at {stage}" + optional details
   - Fix: "Check your OIDC provider configuration. Verify JMAP_OIDC_ISSUER is correct and the provider supports PKCE."
   - Type: 'oidcError'

4. Add noStoredTokens(): JMAPError
   - Message: "No stored authentication tokens found"
   - Fix: "Authenticate first using: npx mcp-twake-mail auth"
   - Type: 'noStoredTokens'

5. Update formatStartupError to handle auth-related errors:
   - If message includes 'token' and 'expired': suggest re-authentication
   - If message includes 'oidc' or 'oauth': suggest checking OIDC config

The CLI command will be implemented in Phase 6, but the error messages should already reference it.
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Run `npm test` - existing error tests still pass.
Manually verify error messages are AI-friendly (what went wrong + how to fix).
  </verify>
  <done>
Auth error factories exist with clear re-authentication instructions. All error messages include actionable fix guidance.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   npm run build
   npm test
   ```
   All tests pass, no TypeScript errors.

2. Config verification:
   - Set JMAP_AUTH_METHOD=oidc without JMAP_OIDC_ISSUER -> validation fails with clear message
   - Set JMAP_AUTH_METHOD=oidc with JMAP_OIDC_ISSUER and JMAP_OIDC_CLIENT_ID -> validation passes

3. Token store verification:
   - Tokens saved with 0600 permissions
   - Tokens load correctly after save
   - clearTokens removes the file

4. Error verification:
   - JMAPError.tokenExpired() returns error with re-auth instructions
   - JMAPError.refreshFailed() returns error with re-auth instructions
</verification>

<success_criteria>
- Config schema validates OIDC fields when JMAP_AUTH_METHOD is 'oidc'
- Token store persists tokens to ~/.mcp-twake-mail/tokens.json with 0600 permissions
- Auth errors provide clear re-authentication instructions
- All existing tests pass
- New token store tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-01-SUMMARY.md`
</output>
