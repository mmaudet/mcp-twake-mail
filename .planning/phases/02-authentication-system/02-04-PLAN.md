---
phase: 02-authentication-system
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/jmap/client.ts
  - tests/jmap/client.test.ts
autonomous: true

must_haves:
  truths:
    - "Basic auth works with username/password from config"
    - "Bearer auth works with static token from config"
    - "OIDC auth loads tokens from store and auto-refreshes"
    - "All auth methods produce valid Authorization headers"
  artifacts:
    - path: "src/jmap/client.ts"
      provides: "Integrated auth header generation"
      contains: "TokenRefresher"
  key_links:
    - from: "src/jmap/client.ts"
      to: "src/auth/token-refresh.ts"
      via: "TokenRefresher.ensureValidToken"
      pattern: "tokenRefresher\\.ensureValidToken"
    - from: "src/jmap/client.ts"
      to: "Authorization header"
      via: "getAuthHeaders returns Bearer for OIDC"
      pattern: "Authorization.*Bearer"
---

<objective>
Integrate the authentication system with JMAPClient, updating getAuthHeaders() to use token store and automatic refresh for OIDC authentication.

Purpose: This is the final integration that connects all auth components. After this plan, the JMAPClient automatically handles all three auth methods: Basic uses config credentials, Bearer uses config token, OIDC uses stored tokens with auto-refresh.

Output: Updated JMAPClient with OIDC-aware authentication that auto-refreshes tokens before they expire.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-system/02-RESEARCH.md
@.planning/phases/02-authentication-system/02-01-SUMMARY.md
@.planning/phases/02-authentication-system/02-02-SUMMARY.md
@.planning/phases/02-authentication-system/02-03-SUMMARY.md

# Files to modify
@src/jmap/client.ts
@tests/jmap/client.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update JMAPClient with OIDC token management</name>
  <files>src/jmap/client.ts</files>
  <action>
Update JMAPClient to integrate with the token refresh system for OIDC authentication:

1. Add imports at top of file:
   ```typescript
   import { TokenRefresher, createTokenRefresher } from '../auth/token-refresh.js';
   ```

2. Add private field to JMAPClient class:
   ```typescript
   private tokenRefresher: TokenRefresher | null = null;
   ```

3. Add initialization in constructor (after existing assignments):
   ```typescript
   // Initialize token refresher for OIDC auth
   if (config.JMAP_AUTH_METHOD === 'oidc') {
     this.tokenRefresher = createTokenRefresher(
       config.JMAP_OIDC_ISSUER!,
       config.JMAP_OIDC_CLIENT_ID!
     );
   }
   ```

4. Change getAuthHeaders() from sync to async:
   ```typescript
   /**
    * Generate authentication headers based on configured auth method.
    * For OIDC, ensures token is valid and refreshes if needed.
    * @returns Headers object with Authorization and Content-Type
    */
   private async getAuthHeaders(): Promise<Record<string, string>> {
     const headers: Record<string, string> = {
       'Content-Type': 'application/json',
     };

     if (this.config.JMAP_AUTH_METHOD === 'basic') {
       const credentials = `${this.config.JMAP_USERNAME}:${this.config.JMAP_PASSWORD}`;
       const token = Buffer.from(credentials).toString('base64');
       headers['Authorization'] = `Basic ${token}`;
     } else if (this.config.JMAP_AUTH_METHOD === 'bearer') {
       // Bearer uses static token from config
       headers['Authorization'] = `Bearer ${this.config.JMAP_TOKEN}`;
     } else if (this.config.JMAP_AUTH_METHOD === 'oidc') {
       // OIDC uses stored tokens with auto-refresh
       if (!this.tokenRefresher) {
         throw new JMAPError(
           'Token refresher not initialized',
           'configError',
           'OIDC authentication requires JMAP_OIDC_ISSUER and JMAP_OIDC_CLIENT_ID to be set.'
         );
       }
       const tokens = await this.tokenRefresher.ensureValidToken();
       headers['Authorization'] = `Bearer ${tokens.accessToken}`;
     }

     return headers;
   }
   ```

5. Update fetchSession() to await getAuthHeaders():
   Change:
   ```typescript
   headers: this.getAuthHeaders(),
   ```
   To:
   ```typescript
   headers: await this.getAuthHeaders(),
   ```

6. Update request() to await getAuthHeaders():
   Change:
   ```typescript
   headers: this.getAuthHeaders(),
   ```
   To:
   ```typescript
   headers: await this.getAuthHeaders(),
   ```

7. fetchSession() and request() are already async, so no signature changes needed.

IMPORTANT: The async change is internal only. The public API (fetchSession, request) already returns Promises, so this is backward compatible.
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Run `npm test` - all existing tests still pass (basic/bearer paths unchanged).
  </verify>
  <done>
JMAPClient.getAuthHeaders() is async and uses TokenRefresher for OIDC auth.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OIDC auth tests to JMAPClient</name>
  <files>tests/jmap/client.test.ts</files>
  <action>
Add test cases for OIDC authentication in JMAPClient:

1. Add imports for auth mocking:
   ```typescript
   import { vi } from 'vitest';
   ```

2. Mock the auth module before the test file (at top level or in beforeAll):
   ```typescript
   vi.mock('../src/auth/token-refresh.js', () => ({
     createTokenRefresher: vi.fn(),
     TokenRefresher: vi.fn(),
   }));
   ```

3. Add new describe block for OIDC authentication tests:

   ```typescript
   describe('OIDC authentication', () => {
     it('should use stored token from TokenRefresher', async () => {
       // Setup: mock token refresher
       const mockTokenRefresher = {
         ensureValidToken: vi.fn().mockResolvedValue({
           accessToken: 'oidc-access-token',
           refreshToken: 'oidc-refresh-token',
           expiresAt: Math.floor(Date.now() / 1000) + 3600,
         }),
       };

       // Create OIDC config
       const oidcConfig = {
         JMAP_SESSION_URL: 'https://jmap.example.com/.well-known/jmap',
         JMAP_AUTH_METHOD: 'oidc' as const,
         JMAP_OIDC_ISSUER: 'https://auth.example.com',
         JMAP_OIDC_CLIENT_ID: 'test-client',
         JMAP_OIDC_SCOPE: 'openid email offline_access',
         JMAP_OIDC_REDIRECT_PORT: 3000,
         JMAP_REQUEST_TIMEOUT: 30000,
         LOG_LEVEL: 'info' as const,
       };

       // Mock createTokenRefresher to return our mock
       const { createTokenRefresher } = await import('../src/auth/token-refresh.js');
       vi.mocked(createTokenRefresher).mockReturnValue(mockTokenRefresher as any);

       // Create client
       const client = new JMAPClient(oidcConfig, mockLogger);

       // Mock fetch for session
       global.fetch = vi.fn().mockResolvedValue({
         ok: true,
         json: () => Promise.resolve(validSessionResponse),
       });

       // Fetch session (triggers getAuthHeaders with OIDC)
       await client.fetchSession();

       // Verify token refresher was used
       expect(mockTokenRefresher.ensureValidToken).toHaveBeenCalled();

       // Verify Authorization header used OIDC token
       expect(global.fetch).toHaveBeenCalledWith(
         expect.any(String),
         expect.objectContaining({
           headers: expect.objectContaining({
             'Authorization': 'Bearer oidc-access-token',
           }),
         })
       );
     });

     it('should throw if token refresher returns no tokens', async () => {
       const mockTokenRefresher = {
         ensureValidToken: vi.fn().mockRejectedValue(
           new JMAPError(
             'No stored authentication tokens found',
             'noStoredTokens',
             'Authenticate first using: npx mcp-twake-mail auth'
           )
         ),
       };

       const oidcConfig = {
         JMAP_SESSION_URL: 'https://jmap.example.com/.well-known/jmap',
         JMAP_AUTH_METHOD: 'oidc' as const,
         JMAP_OIDC_ISSUER: 'https://auth.example.com',
         JMAP_OIDC_CLIENT_ID: 'test-client',
         JMAP_OIDC_SCOPE: 'openid email offline_access',
         JMAP_OIDC_REDIRECT_PORT: 3000,
         JMAP_REQUEST_TIMEOUT: 30000,
         LOG_LEVEL: 'info' as const,
       };

       const { createTokenRefresher } = await import('../src/auth/token-refresh.js');
       vi.mocked(createTokenRefresher).mockReturnValue(mockTokenRefresher as any);

       const client = new JMAPClient(oidcConfig, mockLogger);

       await expect(client.fetchSession()).rejects.toThrow('No stored authentication tokens found');
     });

     it('should propagate refresh errors with re-auth message', async () => {
       const mockTokenRefresher = {
         ensureValidToken: vi.fn().mockRejectedValue(
           new JMAPError(
             'Token refresh failed',
             'refreshFailed',
             'Your session has expired. Re-authenticate using: npx mcp-twake-mail auth'
           )
         ),
       };

       const oidcConfig = {
         JMAP_SESSION_URL: 'https://jmap.example.com/.well-known/jmap',
         JMAP_AUTH_METHOD: 'oidc' as const,
         JMAP_OIDC_ISSUER: 'https://auth.example.com',
         JMAP_OIDC_CLIENT_ID: 'test-client',
         JMAP_OIDC_SCOPE: 'openid email offline_access',
         JMAP_OIDC_REDIRECT_PORT: 3000,
         JMAP_REQUEST_TIMEOUT: 30000,
         LOG_LEVEL: 'info' as const,
       };

       const { createTokenRefresher } = await import('../src/auth/token-refresh.js');
       vi.mocked(createTokenRefresher).mockReturnValue(mockTokenRefresher as any);

       const client = new JMAPClient(oidcConfig, mockLogger);

       await expect(client.fetchSession()).rejects.toThrow('Token refresh failed');
     });
   });
   ```

4. Ensure existing basic/bearer tests still work (they should since that code path is unchanged).

Note: The exact mocking approach may need adjustment based on how the test file is structured. The key is to mock createTokenRefresher to return a mock TokenRefresher that we control.
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Run `npm test -- tests/jmap/client.test.ts` - all tests pass including new OIDC tests.
  </verify>
  <done>
JMAPClient tests verify OIDC authentication uses token store and handles refresh errors.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   npm run build
   npm test
   ```
   All tests pass, no TypeScript errors.

2. Auth method verification:
   - Basic auth: Uses username:password base64 encoded
   - Bearer auth: Uses static JMAP_TOKEN from config
   - OIDC auth: Uses stored token via TokenRefresher

3. Error handling verification:
   - noStoredTokens error propagates with re-auth message
   - refreshFailed error propagates with re-auth message

4. Backward compatibility:
   - Existing basic/bearer tests still pass
   - No public API changes (fetchSession, request still return Promises)
</verification>

<success_criteria>
- JMAPClient.getAuthHeaders() is async and handles all three auth methods
- OIDC auth uses TokenRefresher.ensureValidToken() for auto-refresh
- Auth errors propagate with clear re-authentication instructions
- All existing tests pass
- New OIDC tests verify token store integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-04-SUMMARY.md`
</output>
