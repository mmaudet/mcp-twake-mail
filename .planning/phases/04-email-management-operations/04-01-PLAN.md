---
phase: 04-email-management-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp/tools/email-operations.ts
  - src/mcp/tools/index.ts
  - src/types/jmap.ts
autonomous: true

must_haves:
  truths:
    - "AI can mark an email as read"
    - "AI can mark an email as unread"
    - "AI can delete an email (move to trash by default)"
    - "AI can permanently delete an email when requested"
  artifacts:
    - path: "src/mcp/tools/email-operations.ts"
      provides: "mark_as_read, mark_as_unread, delete_email tools"
      exports: ["registerEmailOperationTools"]
    - path: "src/types/jmap.ts"
      provides: "EmailSetResponse type for Email/set responses"
      contains: "EmailSetResponse"
  key_links:
    - from: "src/mcp/tools/email-operations.ts"
      to: "src/jmap/client.ts"
      via: "jmapClient.request() with Email/set"
      pattern: "Email/set"
    - from: "src/mcp/tools/index.ts"
      to: "src/mcp/tools/email-operations.ts"
      via: "registerEmailOperationTools import"
      pattern: "registerEmailOperationTools"
---

<objective>
Implement mark_as_read, mark_as_unread, and delete_email MCP tools using JMAP Email/set method.

Purpose: Enable AI assistants to modify email read status and delete emails, completing the basic email management workflow.

Output: Three new MCP tools (mark_as_read, mark_as_unread, delete_email) with proper annotations for write/destructive operations.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-email-management-operations/04-RESEARCH.md

@src/mcp/tools/email.ts (existing email tools pattern)
@src/mcp/tools/index.ts (tool registration aggregator)
@src/jmap/client.ts (JMAPClient with request/parseMethodResponse)
@src/types/jmap.ts (JMAP types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EmailSetResponse type and annotation constants</name>
  <files>src/types/jmap.ts, src/mcp/tools/email-operations.ts</files>
  <action>
1. Add EmailSetResponse interface to src/types/jmap.ts:
```typescript
/** JMAP Email/set response (RFC 8621 Section 4.3) */
export interface EmailSetResponse {
  accountId: string;
  oldState: string;
  newState: string;
  created?: Record<string, { id: string; blobId: string; threadId: string }>;
  updated?: Record<string, null>;
  destroyed?: string[];
  notCreated?: Record<string, { type: string; description?: string }>;
  notUpdated?: Record<string, { type: string; description?: string }>;
  notDestroyed?: Record<string, { type: string; description?: string }>;
}
```

2. Create src/mcp/tools/email-operations.ts with:
- JSDoc module comment explaining write operations
- EMAIL_WRITE_ANNOTATIONS constant (readOnlyHint: false, destructiveHint: false, idempotentHint: true, openWorldHint: true)
- EMAIL_DESTRUCTIVE_ANNOTATIONS constant (readOnlyHint: false, destructiveHint: true, idempotentHint: false, openWorldHint: true)
- Import z from zod, McpServer, ToolAnnotations, JMAPClient, Logger, EmailSetResponse
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>EmailSetResponse type exists in jmap.ts, email-operations.ts has annotation constants and imports</done>
</task>

<task type="auto">
  <name>Task 2: Implement mark_as_read and mark_as_unread tools</name>
  <files>src/mcp/tools/email-operations.ts</files>
  <action>
Implement both tools using JMAP patch syntax for keywords:

mark_as_read:
- Input: emailId (z.string())
- Use Email/set with update: { [emailId]: { 'keywords/$seen': true } }
- Use EMAIL_WRITE_ANNOTATIONS
- Return { success: true, emailId, marked: 'read' } on success
- Check notUpdated in response and return isError with description if present

mark_as_unread:
- Input: emailId (z.string())
- Use Email/set with update: { [emailId]: { 'keywords/$seen': null } }
- Use EMAIL_WRITE_ANNOTATIONS
- Return { success: true, emailId, marked: 'unread' } on success
- Check notUpdated in response and return isError with description if present

Follow the exact error handling pattern from existing tools (try/catch, logger.error, isError response).
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>mark_as_read and mark_as_unread tools implemented with patch syntax</done>
</task>

<task type="auto">
  <name>Task 3: Implement delete_email tool and register all tools</name>
  <files>src/mcp/tools/email-operations.ts, src/mcp/tools/index.ts</files>
  <action>
1. Implement delete_email tool:
- Input: emailId (z.string()), permanent (z.boolean().default(false))
- Use EMAIL_DESTRUCTIVE_ANNOTATIONS
- If permanent=true: Use Email/set destroy: [emailId]
- If permanent=false (default):
  a. First query Trash mailbox: Mailbox/query with filter: { role: 'trash' }
  b. Then Email/set update: { [emailId]: { mailboxIds: { [trashMailboxId]: true } } }
  c. If no Trash found, log warning and fall back to permanent delete
- Return { success: true, emailId, action: 'permanently_deleted' | 'moved_to_trash' }
- Check notUpdated/notDestroyed in response

2. Create registerEmailOperationTools function that registers all three tools

3. Update src/mcp/tools/index.ts:
- Import registerEmailOperationTools from './email-operations.js'
- Add call to registerEmailOperationTools(server, jmapClient, logger) in registerAllTools
- Update comment to list new tools
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>delete_email tool implemented with soft/hard delete, tools registered in index.ts</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Lint check: `npm run lint` passes (if configured)
3. Tool signatures match research patterns from 04-RESEARCH.md
4. All three tools use correct MCP annotations
5. Error handling follows existing tool patterns
</verification>

<success_criteria>
1. mark_as_read tool sets $seen keyword using patch syntax
2. mark_as_unread tool removes $seen keyword using patch syntax
3. delete_email moves to Trash by default, permanently deletes when permanent=true
4. All tools registered via registerAllTools()
5. EMAIL_WRITE_ANNOTATIONS and EMAIL_DESTRUCTIVE_ANNOTATIONS constants defined
6. EmailSetResponse type added to src/types/jmap.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-email-management-operations/04-01-SUMMARY.md`
</output>
