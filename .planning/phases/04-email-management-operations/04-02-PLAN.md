---
phase: 04-email-management-operations
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/mcp/tools/email-operations.ts
  - src/mcp/tools/email-operations.test.ts
autonomous: true

must_haves:
  truths:
    - "AI can move an email to a different mailbox"
    - "AI can add a label (mailbox) to an email without removing existing labels"
    - "AI can remove a label (mailbox) from an email"
    - "AI can create a draft email in Drafts mailbox"
  artifacts:
    - path: "src/mcp/tools/email-operations.ts"
      provides: "move_email, add_label, remove_label, create_draft tools"
      exports: ["registerEmailOperationTools"]
    - path: "src/mcp/tools/email-operations.test.ts"
      provides: "Unit tests for all email operation tools"
      min_lines: 100
  key_links:
    - from: "src/mcp/tools/email-operations.ts"
      to: "src/jmap/client.ts"
      via: "jmapClient.request() with Email/set update/create"
      pattern: "Email/set"
    - from: "create_draft"
      to: "Mailbox/query"
      via: "Query for Drafts mailbox by role"
      pattern: "role.*drafts"
---

<objective>
Implement move_email, add_label, remove_label, and create_draft MCP tools using JMAP Email/set method, plus unit tests for all email operation tools.

Purpose: Enable AI assistants to organize emails between mailboxes and create draft emails for later editing/sending.

Output: Four new MCP tools (move_email, add_label, remove_label, create_draft) with proper annotations, plus comprehensive unit tests.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-email-management-operations/04-RESEARCH.md
@.planning/phases/04-email-management-operations/04-01-SUMMARY.md

@src/mcp/tools/email-operations.ts (from Plan 01 - has annotations, types, mark_as_read, mark_as_unread, delete_email)
@src/jmap/client.ts (JMAPClient with request/parseMethodResponse)
@src/types/jmap.ts (JMAP types including EmailSetResponse)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement move_email, add_label, and remove_label tools</name>
  <files>src/mcp/tools/email-operations.ts</files>
  <action>
Add three mailbox manipulation tools to email-operations.ts (file already has mark_as_read, mark_as_unread, delete_email from Plan 01):

1. move_email:
- Input: emailId (z.string()), targetMailboxId (z.string())
- Use EMAIL_WRITE_ANNOTATIONS (idempotent - moving to same place is safe)
- Email/set update: { [emailId]: { mailboxIds: { [targetMailboxId]: true } } }
- This replaces ALL mailboxIds (move, not copy)
- Return { success: true, emailId, targetMailboxId }

2. add_label:
- Input: emailId (z.string()), mailboxId (z.string())
- Use EMAIL_WRITE_ANNOTATIONS
- Use JMAP patch syntax: { [emailId]: { [`mailboxIds/${mailboxId}`]: true } }
- This ADDS to existing mailboxIds without removing others
- Return { success: true, emailId, addedMailboxId: mailboxId }

3. remove_label:
- Input: emailId (z.string()), mailboxId (z.string())
- Use EMAIL_WRITE_ANNOTATIONS
- Use JMAP patch syntax: { [emailId]: { [`mailboxIds/${mailboxId}`]: null } }
- Handle error case where email only has one mailbox (JMAP constraint)
- If notUpdated with type 'invalidProperties', return friendly error: "Cannot remove label: email must belong to at least one mailbox"
- Return { success: true, emailId, removedMailboxId: mailboxId }

All tools: Follow existing error handling pattern (try/catch, logger, check notUpdated).
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>move_email, add_label, remove_label tools implemented with correct JMAP patterns</done>
</task>

<task type="auto">
  <name>Task 2: Implement create_draft tool</name>
  <files>src/mcp/tools/email-operations.ts</files>
  <action>
Add create_draft tool with Email/set create operation:

Input schema:
- to: z.array(z.string().email()).optional() - recipient addresses
- cc: z.array(z.string().email()).optional() - CC addresses
- bcc: z.array(z.string().email()).optional() - BCC addresses
- subject: z.string().optional() - email subject
- body: z.string().optional() - plain text body
- inReplyTo: z.string().optional() - Message-ID for replies

Annotations:
- readOnlyHint: false
- destructiveHint: false
- idempotentHint: false (each call creates NEW draft)
- openWorldHint: true

Implementation:
1. Query Drafts mailbox: Mailbox/query with filter: { role: 'drafts' }
2. Check for Drafts mailbox - if not found, return error
3. Email/set create with:
   - mailboxIds: { [draftsMailboxId]: true }
   - keywords: { '$draft': true, '$seen': true }
   - to/cc/bcc: map string arrays to { email: string }[]
   - subject: args.subject || ''
   - bodyStructure: { type: 'text/plain', partId: '1' }
   - bodyValues: { '1': { value: args.body || '', isEncodingProblem: false, isTruncated: false } }
   - inReplyTo: [args.inReplyTo] if provided
4. Check notCreated in response
5. Return { success: true, draftId: created.id, threadId: created.threadId }

Ensure create_draft is registered in registerEmailOperationTools function.
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>create_draft tool implemented with proper $draft keyword and Drafts mailbox placement</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for email operation tools</name>
  <files>src/mcp/tools/email-operations.test.ts</files>
  <action>
Create test file with unit tests for all email operation tools:

1. Test setup:
- Mock JMAPClient with jest.fn() for request, parseMethodResponse, getSession
- Mock Logger (silent)
- Mock McpServer with registerTool that captures handlers

2. Test cases for mark_as_read:
- Success case: returns { success: true, emailId, marked: 'read' }
- Error case: notUpdated in response returns isError

3. Test cases for mark_as_unread:
- Success case: returns { success: true, emailId, marked: 'unread' }
- Error case: notUpdated in response returns isError

4. Test cases for delete_email:
- Soft delete (default): moves to Trash
- Permanent delete: destroys email
- No Trash mailbox: falls back to permanent delete

5. Test cases for move_email:
- Success: replaces mailboxIds with target
- Error case: notUpdated returns isError

6. Test cases for add_label:
- Success: adds mailbox using patch syntax
- Error case: notUpdated returns isError

7. Test cases for remove_label:
- Success: removes mailbox using patch syntax
- Error with invalidProperties: returns friendly "must belong to at least one mailbox" message

8. Test cases for create_draft:
- Success: creates draft in Drafts mailbox with $draft keyword
- No Drafts mailbox: returns error
- notCreated: returns error with description

Use describe blocks for each tool, test both success and error paths.
Follow existing test patterns from src/mcp/tools/email.test.ts or similar.
  </action>
  <verify>npm test -- src/mcp/tools/email-operations.test.ts passes</verify>
  <done>Unit tests cover all 7 email operation tools with success and error cases</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. All tests pass: `npm test -- src/mcp/tools/email-operations.test.ts`
3. Tool signatures match research patterns from 04-RESEARCH.md
4. move_email uses full mailboxIds replacement (move semantics)
5. add_label/remove_label use patch syntax (additive/subtractive)
6. create_draft includes $draft and $seen keywords
</verification>

<success_criteria>
1. move_email replaces all mailboxIds with target (true move, not copy)
2. add_label uses patch syntax to add without removing existing
3. remove_label uses patch syntax to remove, handles "last mailbox" error gracefully
4. create_draft creates email in Drafts with $draft and $seen keywords
5. All tools have proper MCP annotations
6. Unit tests pass for all 7 email operation tools
</success_criteria>

<output>
After completion, create `.planning/phases/04-email-management-operations/04-02-SUMMARY.md`
</output>
