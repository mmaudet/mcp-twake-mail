---
phase: 03-core-read-operations
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/mcp/tools/email.ts
  - src/mcp/tools/index.ts
  - src/mcp/server.ts
autonomous: true

must_haves:
  truths:
    - "AI assistant can retrieve email by ID with get_email tool"
    - "AI assistant can search emails with filters via search_emails tool"
    - "AI assistant can get mailboxes for an email via get_email_labels tool"
    - "All email tools have MCP annotations (readOnlyHint: true, destructiveHint: false, idempotentHint: true, openWorldHint: true)"
  artifacts:
    - path: "src/mcp/tools/email.ts"
      provides: "Email MCP tools"
      exports: ["registerEmailTools"]
    - path: "src/mcp/tools/index.ts"
      provides: "Tool registration aggregator"
      exports: ["registerAllTools"]
  key_links:
    - from: "src/mcp/tools/email.ts"
      to: "src/transformers/email.ts"
      via: "import transformEmail"
      pattern: "import.*transformEmail.*from.*transformers"
    - from: "src/mcp/tools/email.ts"
      to: "src/jmap/client.ts"
      via: "JMAPClient parameter"
      pattern: "jmapClient.*JMAPClient"
    - from: "src/mcp/server.ts"
      to: "src/mcp/tools/index.ts"
      via: "registerAllTools"
      pattern: "registerAllTools"
---

<objective>
Implement the three email MCP tools: get_email, search_emails, get_email_labels.

Purpose: These tools enable AI assistants to read and search emails. Each tool must have proper MCP annotations (MCP-02) and return SimplifiedEmail DTOs (TRANS-01).

Output: Working email tools registered with the MCP server.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-read-operations/03-RESEARCH.md

# Prior plan outputs needed
@.planning/phases/03-core-read-operations/03-01-SUMMARY.md
@.planning/phases/03-core-read-operations/03-02-SUMMARY.md

# Existing codebase
@src/jmap/client.ts
@src/types/dto.ts
@src/transformers/email.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Email Tools Module</name>
  <files>src/mcp/tools/email.ts</files>
  <action>
Create src/mcp/tools/email.ts implementing three tools:

**1. get_email tool (EMAIL-03)**
- Input: emailId (string, required), properties (string[], optional)
- JMAP: Email/get with specific id
- Properties to fetch: id, threadId, mailboxIds, keywords, from, to, cc, bcc, subject, receivedAt, sentAt, preview, hasAttachment, bodyValues, textBody, htmlBody, attachments
- Use fetchBodyProperties option to get body content: ['textBody', 'htmlBody'] with bodyProperties: ['partId', 'blobId', 'type', 'name', 'size']
- Transform with transformEmail() before returning
- Return full email content as JSON

**2. search_emails tool (EMAIL-04)**
- Inputs (all optional): mailboxId, from, to, subject, text, before, after, hasAttachment, unreadOnly, flagged, limit (default 20, max 100)
- Build JMAP filter from inputs:
  - mailboxId -> inMailbox
  - from/to/subject/text -> direct mapping
  - before/after -> date comparisons
  - hasAttachment -> direct mapping
  - unreadOnly -> notKeyword: '$seen'
  - flagged -> hasKeyword: '$flagged'
- Use back-reference pattern: Email/query -> Email/get with '#ids'
- Sort by receivedAt descending
- Fetch summary properties only: id, threadId, mailboxIds, keywords, from, to, subject, receivedAt, preview, hasAttachment
- Transform results with transformEmail()
- Return array of SimplifiedEmail

**3. get_email_labels tool (EMAIL-11)**
- Input: emailId (string, required)
- JMAP: Email/get to fetch mailboxIds
- Return array of mailbox IDs the email belongs to
- Simple tool that extracts mailboxIds from email

**For all tools:**
- Use Zod schemas for input validation
- Add ToolAnnotations: { title, readOnlyHint: true, destructiveHint: false, idempotentHint: true, openWorldHint: true }
- Return errors with isError: true and descriptive message
- Use try/catch with logger.error for exceptions

Export function: registerEmailTools(server: McpServer, jmapClient: JMAPClient, logger: Logger)
  </action>
  <verify>
```bash
# TypeScript compile check
npx tsc --noEmit

# Verify exports
node -e "import('./dist/mcp/tools/email.js').then(m => console.log('Exports:', Object.keys(m)))"
```
  </verify>
  <done>
- get_email tool retrieves single email with full content
- search_emails tool supports all required filters
- get_email_labels tool returns mailbox IDs for email
- All tools have correct MCP annotations
- All tools use transformEmail() for response formatting
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Tool Registration Aggregator and Wire to Server</name>
  <files>src/mcp/tools/index.ts, src/mcp/server.ts</files>
  <action>
**Create src/mcp/tools/index.ts:**
- Export registerAllTools(server, jmapClient, logger) function
- Import and call registerEmailTools()
- (Mailbox tools will be added in next plan)

**Update src/mcp/server.ts:**
- Import registerAllTools from './tools/index.js'
- Call registerAllTools(server, jmapClient, logger) after creating server, before connecting transport

The tool registration must happen after McpServer creation but before server.connect(transport).
  </action>
  <verify>
```bash
# Full build
npm run build

# Verify tools index
node -e "import('./dist/mcp/tools/index.js').then(m => console.log('Exports:', Object.keys(m)))"
```
  </verify>
  <done>
- src/mcp/tools/index.ts exports registerAllTools()
- src/mcp/server.ts calls registerAllTools() before connect()
- Email tools are registered when server starts
  </done>
</task>

</tasks>

<verification>
```bash
# Build everything
npm run build

# TypeScript check
npx tsc --noEmit

# Run existing tests (should still pass)
npm test

# Verify tool registration structure
node -e "
import('./dist/mcp/tools/email.js').then(m => {
  console.log('registerEmailTools:', typeof m.registerEmailTools);
})
"
```
</verification>

<success_criteria>
- get_email tool retrieves email by ID with full content (EMAIL-03)
- search_emails tool supports filters: mailboxId, from, to, subject, text, before, after, hasAttachment, unreadOnly, flagged, limit (EMAIL-04)
- get_email_labels tool returns mailbox IDs for email (EMAIL-11)
- All tools have MCP annotations: readOnlyHint, destructiveHint, idempotentHint, openWorldHint (MCP-02)
- All tools transform responses using transformEmail() (TRANS-01, TRANS-03)
- Tools registered via registerAllTools() in server.ts
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-read-operations/03-03-SUMMARY.md`
</output>
