---
phase: 03-core-read-operations
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/mcp/tools/mailbox.ts
  - src/mcp/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "AI assistant can retrieve mailbox by ID with get_mailbox tool"
    - "AI assistant can list all mailboxes with list_mailboxes tool"
    - "Mailboxes can be filtered by role (inbox, drafts, sent, trash, etc.)"
    - "All mailbox tools have MCP annotations (readOnlyHint: true, destructiveHint: false, idempotentHint: true, openWorldHint: true)"
  artifacts:
    - path: "src/mcp/tools/mailbox.ts"
      provides: "Mailbox MCP tools"
      exports: ["registerMailboxTools"]
  key_links:
    - from: "src/mcp/tools/mailbox.ts"
      to: "src/transformers/mailbox.ts"
      via: "import transformMailbox"
      pattern: "import.*transformMailbox.*from.*transformers"
    - from: "src/mcp/tools/mailbox.ts"
      to: "src/jmap/client.ts"
      via: "JMAPClient parameter"
      pattern: "jmapClient.*JMAPClient"
    - from: "src/mcp/tools/index.ts"
      to: "src/mcp/tools/mailbox.ts"
      via: "import registerMailboxTools"
      pattern: "import.*registerMailboxTools"
---

<objective>
Implement the two mailbox MCP tools: get_mailbox, list_mailboxes.

Purpose: These tools enable AI assistants to navigate mailbox structure. Each tool must have proper MCP annotations (MCP-02) and return SimplifiedMailbox DTOs (TRANS-02).

Output: Working mailbox tools registered with the MCP server.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-read-operations/03-RESEARCH.md

# Prior plan outputs needed
@.planning/phases/03-core-read-operations/03-01-SUMMARY.md
@.planning/phases/03-core-read-operations/03-02-SUMMARY.md

# Existing codebase
@src/jmap/client.ts
@src/types/dto.ts
@src/transformers/mailbox.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Mailbox Tools Module</name>
  <files>src/mcp/tools/mailbox.ts</files>
  <action>
Create src/mcp/tools/mailbox.ts implementing two tools:

**1. get_mailbox tool (MBOX-01)**
- Input: mailboxId (string, required)
- JMAP: Mailbox/get with ids: [mailboxId]
- Properties: id, name, parentId, role, sortOrder, totalEmails, unreadEmails, totalThreads, unreadThreads
- Transform with transformMailbox() before returning
- Return single SimplifiedMailbox or error if not found

**2. list_mailboxes tool (MBOX-02)**
- Input: role (enum, optional) - filter by role
- Roles: 'inbox', 'drafts', 'sent', 'trash', 'archive', 'spam', 'junk', 'important', 'all'
- JMAP: Mailbox/get (all mailboxes, no filter in JMAP - filter client-side)
- Properties: id, name, parentId, role, sortOrder, totalEmails, unreadEmails, totalThreads, unreadThreads
- Filter by role if specified (client-side after fetch)
- Transform all results with transformMailbox()
- Return array of SimplifiedMailbox

**For all tools:**
- Use Zod schemas for input validation
- Add ToolAnnotations: { title, readOnlyHint: true, destructiveHint: false, idempotentHint: true, openWorldHint: true }
- Return errors with isError: true and descriptive message
- Use try/catch with logger.error for exceptions

Export function: registerMailboxTools(server: McpServer, jmapClient: JMAPClient, logger: Logger)
  </action>
  <verify>
```bash
# TypeScript compile check
npx tsc --noEmit

# Verify exports
node -e "import('./dist/mcp/tools/mailbox.js').then(m => console.log('Exports:', Object.keys(m)))"
```
  </verify>
  <done>
- get_mailbox tool retrieves single mailbox by ID
- list_mailboxes tool returns all mailboxes with optional role filter
- All tools have correct MCP annotations
- All tools use transformMailbox() for response formatting
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Mailbox Tools to Registration</name>
  <files>src/mcp/tools/index.ts</files>
  <action>
Update src/mcp/tools/index.ts:

1. Import registerMailboxTools from './mailbox.js'
2. Call registerMailboxTools(server, jmapClient, logger) in registerAllTools()

After this change, registerAllTools() should call both:
- registerEmailTools()
- registerMailboxTools()
  </action>
  <verify>
```bash
# Full build
npm run build

# Verify all tools are registered
node -e "
import('./dist/mcp/tools/index.js').then(m => {
  console.log('registerAllTools:', typeof m.registerAllTools);
})
"
```
  </verify>
  <done>
- src/mcp/tools/index.ts imports and calls registerMailboxTools()
- Both email and mailbox tools registered when server starts
  </done>
</task>

</tasks>

<verification>
```bash
# Build everything
npm run build

# TypeScript check
npx tsc --noEmit

# Run all tests
npm test

# Verify both tool modules exist and export correctly
node -e "
Promise.all([
  import('./dist/mcp/tools/email.js'),
  import('./dist/mcp/tools/mailbox.js'),
  import('./dist/mcp/tools/index.js')
]).then(([email, mailbox, index]) => {
  console.log('Email tools:', typeof email.registerEmailTools);
  console.log('Mailbox tools:', typeof mailbox.registerMailboxTools);
  console.log('All tools:', typeof index.registerAllTools);
})
"
```
</verification>

<success_criteria>
- get_mailbox tool retrieves mailbox by ID with metadata (MBOX-01)
- list_mailboxes tool returns all mailboxes, filterable by role (MBOX-02)
- All tools have MCP annotations: readOnlyHint, destructiveHint, idempotentHint, openWorldHint (MCP-02)
- All tools transform responses using transformMailbox() (TRANS-02)
- Both email and mailbox tools registered via registerAllTools()
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-read-operations/03-04-SUMMARY.md`
</output>
