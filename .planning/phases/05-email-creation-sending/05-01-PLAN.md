---
phase: 05-email-creation-sending
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/jmap.ts
  - src/mcp/tools/email-sending.ts
autonomous: true

must_haves:
  truths:
    - "Identity type exists in jmap.ts for typing Identity/get responses"
    - "EmailSubmissionSetResponse type exists for EmailSubmission/set responses"
    - "send_email tool sends new email with to, cc, bcc, subject, body, htmlBody"
    - "Sent emails appear in Sent mailbox via onSuccessUpdateEmail pattern"
    - "Submission capability is included when sending emails"
  artifacts:
    - path: "src/types/jmap.ts"
      provides: "Identity and EmailSubmissionSetResponse types"
      contains: "interface Identity"
    - path: "src/mcp/tools/email-sending.ts"
      provides: "send_email MCP tool"
      exports: ["registerEmailSendingTools"]
  key_links:
    - from: "src/mcp/tools/email-sending.ts"
      to: "src/jmap/client.ts"
      via: "jmapClient.request() with submission capability"
      pattern: "urn:ietf:params:jmap:submission"
    - from: "src/mcp/tools/email-sending.ts"
      to: "src/types/jmap.ts"
      via: "Identity and EmailSubmissionSetResponse imports"
      pattern: "import.*Identity.*from"
---

<objective>
Implement send_email MCP tool for sending new emails via JMAP

Purpose: Enable AI assistants to send new emails with full addressing (to, cc, bcc), subject, and body (plain text + HTML). This fulfills requirement EMAIL-01.

Output: Working send_email tool that creates Email via Email/set, submits via EmailSubmission/set with onSuccessUpdateEmail for Drafts-to-Sent transition.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-email-creation-sending/05-RESEARCH.md

# Existing code to build on
@src/types/jmap.ts
@src/mcp/tools/email-operations.ts
@src/jmap/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Identity and EmailSubmission types to jmap.ts</name>
  <files>src/types/jmap.ts</files>
  <action>
Add the following types to src/types/jmap.ts:

1. **Identity interface** (RFC 8621 Section 6):
```typescript
/** JMAP Identity for email sending (RFC 8621 Section 6) */
export interface Identity {
  id: string;
  name: string;
  email: string;
  replyTo?: Array<{ name?: string; email: string }> | null;
  bcc?: Array<{ name?: string; email: string }> | null;
  textSignature?: string;
  htmlSignature?: string;
  mayDelete: boolean;
}
```

2. **EmailSubmissionSetResponse interface**:
```typescript
/** JMAP EmailSubmission/set response (RFC 8621 Section 7.5) */
export interface EmailSubmissionSetResponse {
  accountId: string;
  oldState: string | null;
  newState: string;
  created?: Record<string, { id: string }>;
  notCreated?: Record<string, { type: string; description?: string }>;
}
```

Place these after the existing EmailSetResponse interface.
  </action>
  <verify>Run `npm run build` - no TypeScript errors related to new types</verify>
  <done>Identity and EmailSubmissionSetResponse types exported from src/types/jmap.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create send_email MCP tool</name>
  <files>src/mcp/tools/email-sending.ts</files>
  <action>
Create new file src/mcp/tools/email-sending.ts with send_email tool:

1. **Import dependencies:**
   - z from 'zod'
   - McpServer from '@modelcontextprotocol/sdk/server/mcp.js'
   - ToolAnnotations from '@modelcontextprotocol/sdk/types.js'
   - JMAPClient from '../../jmap/client.js'
   - Logger from '../../config/logger.js'
   - EmailSetResponse, Identity, EmailSubmissionSetResponse from '../../types/jmap.js'

2. **Define EMAIL_SEND_ANNOTATIONS:**
```typescript
const EMAIL_SEND_ANNOTATIONS: ToolAnnotations = {
  readOnlyHint: false,
  destructiveHint: false,
  idempotentHint: false,  // Each call sends a new email
  openWorldHint: true,
};
```

3. **Define SUBMISSION_USING constant:**
```typescript
const SUBMISSION_USING = [
  'urn:ietf:params:jmap:core',
  'urn:ietf:params:jmap:mail',
  'urn:ietf:params:jmap:submission',
];
```

4. **Create registerEmailSendingTools function:**
```typescript
export function registerEmailSendingTools(
  server: McpServer,
  jmapClient: JMAPClient,
  logger: Logger
): void {
  // Register send_email tool
}
```

5. **Implement send_email tool with these specs:**
   - **Input schema:**
     - to: z.array(z.string().email()).min(1) - Required, at least one recipient
     - cc: z.array(z.string().email()).optional()
     - bcc: z.array(z.string().email()).optional()
     - subject: z.string() - Required
     - body: z.string().optional() - Plain text body
     - htmlBody: z.string().optional() - HTML body

   - **Implementation flow:**
     a. Get session from jmapClient
     b. First request batch (with SUBMISSION_USING):
        - Identity/get to fetch available identities
        - Mailbox/query filter: { role: 'sent' }
        - Mailbox/query filter: { role: 'drafts' }
     c. Validate: throw if no identity, no drafts mailbox
     d. Build bodyStructure based on body/htmlBody:
        - Both provided: multipart/alternative with subParts for text and html
        - Only htmlBody: text/html single part
        - Only body or neither: text/plain single part (empty string if no body)
     e. Build email object with:
        - mailboxIds: { [draftsMailboxId]: true }
        - from: [{ name: identity.name, email: identity.email }]
        - to, cc, bcc converted to EmailAddress format
        - subject
        - bodyStructure and bodyValues as computed above
     f. Second request batch (with SUBMISSION_USING):
        - Email/set create: { 'email': emailObject }
        - EmailSubmission/set create: { 'submission': { identityId, emailId: '#email' } }
        - onSuccessUpdateEmail: { '#submission': { 'keywords/$draft': null, mailbox transitions } }
     g. Check for errors in both Email/set and EmailSubmission/set responses
     h. Return success with emailId and submissionId

   - **Error handling:**
     - No identity: "No sending identity available. Contact your administrator."
     - No drafts mailbox: "No Drafts mailbox found. Cannot send email."
     - Email creation failed: Include error type and description
     - Submission failed: Include error type (forbiddenFrom, forbiddenToSend, etc.)

6. **Log statement at end:**
```typescript
logger.debug('Email sending tools registered: send_email');
```
  </action>
  <verify>Run `npm run build` - no TypeScript errors in email-sending.ts</verify>
  <done>send_email tool implemented in src/mcp/tools/email-sending.ts following JMAP two-phase sending pattern</done>
</task>

<task type="auto">
  <name>Task 3: Register email sending tools in MCP server</name>
  <files>src/mcp/tools/index.ts</files>
  <action>
Update src/mcp/tools/index.ts to register email sending tools:

1. Add import:
```typescript
import { registerEmailSendingTools } from './email-sending.js';
```

2. Add call in registerAllTools function:
```typescript
registerEmailSendingTools(server, jmapClient, logger);
```

Place after the existing registerEmailOperationTools call.
  </action>
  <verify>Run `npm run build && npm test` - build succeeds and all existing tests pass</verify>
  <done>registerEmailSendingTools integrated into registerAllTools, MCP server will expose send_email tool</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm test` - all existing tests pass (no regressions)
3. Types Identity and EmailSubmissionSetResponse are exported from src/types/jmap.ts
4. registerEmailSendingTools is exported and called from src/mcp/tools/index.ts
</verification>

<success_criteria>
1. Identity and EmailSubmissionSetResponse types added to jmap.ts
2. send_email tool created with full input validation (to, cc, bcc, subject, body, htmlBody)
3. Tool uses two-phase sending: Email/set create + EmailSubmission/set
4. Tool includes urn:ietf:params:jmap:submission capability
5. onSuccessUpdateEmail moves email from Drafts to Sent
6. Tool registered via registerAllTools
7. Build passes, existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-email-creation-sending/05-01-SUMMARY.md`
</output>
