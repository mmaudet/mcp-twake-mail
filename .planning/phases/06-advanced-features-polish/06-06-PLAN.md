---
phase: 06-advanced-features-polish
plan: 06
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03", "06-04", "06-05"]
files_modified:
  - vitest.config.ts
  - eslint.config.mjs
  - package.json
  - tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Test coverage is > 80% for all metrics (lines, functions, branches, statements)"
    - "No TypeScript errors when running `npm run build`"
    - "No ESLint warnings when running `npm run lint`"
    - "Package installable via `npx mcp-twake-mail` without errors"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Coverage configuration with 80% thresholds"
      contains: "thresholds"
    - path: "eslint.config.mjs"
      provides: "ESLint flat config with TypeScript support"
      contains: "typescript-eslint"
    - path: "package.json"
      provides: "Quality scripts and metadata"
      contains: "lint"
  key_links:
    - from: "package.json"
      to: "vitest.config.ts"
      via: "test:coverage script"
      pattern: "vitest.*coverage"
    - from: "package.json"
      to: "eslint.config.mjs"
      via: "lint script"
      pattern: "eslint"
---

<objective>
Add quality gates: ESLint configuration, test coverage thresholds, and package validation.

Purpose: Ensure code quality meets production standards before Phase 6 completion. Quality gates provide automated checks for TypeScript correctness, code style, test coverage, and package installability.

Output: Configured ESLint with TypeScript rules, Vitest coverage at 80% threshold, lint and coverage scripts, validated package.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-advanced-features-polish/06-RESEARCH.md

# Existing configuration
@vitest.config.ts - Add coverage configuration
@package.json - Add ESLint deps and scripts
@tsconfig.json - Reference for TypeScript config
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure ESLint with TypeScript</name>
  <files>package.json, eslint.config.mjs</files>
  <action>
1. Install ESLint dependencies:
   ```bash
   npm install -D eslint @eslint/js typescript-eslint
   ```

2. Create eslint.config.mjs (flat config format):

```javascript
// @ts-check
import eslint from '@eslint/js';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  eslint.configs.recommended,
  ...tseslint.configs.recommended,
  {
    files: ['**/*.ts'],
    rules: {
      // Allow unused vars starting with underscore
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
      // Warn on missing return types (not error - too noisy for callbacks)
      '@typescript-eslint/explicit-function-return-type': 'off',
      // Allow explicit any in some cases (MCP SDK types)
      '@typescript-eslint/no-explicit-any': 'warn',
    },
  },
  {
    ignores: ['build/**', 'node_modules/**', 'coverage/**', '*.config.*'],
  }
);
```

3. Add lint script to package.json:
   ```json
   "scripts": {
     "lint": "eslint src/",
     "lint:fix": "eslint src/ --fix"
   }
   ```
  </action>
  <verify>`npm run lint` runs without errors (warnings OK for initial setup)</verify>
  <done>ESLint configured with TypeScript support and flat config</done>
</task>

<task type="auto">
  <name>Task 2: Configure Test Coverage Thresholds</name>
  <files>vitest.config.ts, package.json</files>
  <action>
1. Install coverage provider:
   ```bash
   npm install -D @vitest/coverage-v8
   ```

2. Update vitest.config.ts with coverage configuration:

```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'lcov', 'html'],
      include: ['src/**/*.ts'],
      exclude: [
        'src/**/*.test.ts',
        'src/**/__tests__/**',
        'src/cli/**', // CLI prompts are hard to test, exclude for now
      ],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 80,
        statements: 80,
      },
    },
  },
});
```

3. Add coverage script to package.json:
   ```json
   "scripts": {
     "test:coverage": "vitest run --coverage"
   }
   ```

Note: CLI code excluded from coverage thresholds because interactive prompts
require manual testing. Core logic (JMAP client, tools, auth) is covered.
  </action>
  <verify>`npm run test:coverage` runs and shows coverage report</verify>
  <done>Coverage thresholds configured at 80% with v8 provider</done>
</task>

<task type="auto">
  <name>Task 3: Fix Any Lint or Coverage Issues</name>
  <files>Various source files as needed</files>
  <action>
Run quality checks and fix any issues:

1. Run ESLint and fix issues:
   ```bash
   npm run lint
   # If errors, run: npm run lint:fix
   ```

   Common fixes:
   - Add underscore prefix to unused params (e.g., `_error`)
   - Add explicit types where warned
   - Remove unused imports

2. Run coverage and check thresholds:
   ```bash
   npm run test:coverage
   ```

   If below 80%:
   - Add tests for uncovered branches/functions
   - Focus on critical paths (JMAP client, transformers, tools)
   - Check coverage report: `open coverage/index.html`

3. Verify TypeScript compilation:
   ```bash
   npm run build
   ```

4. Test package structure:
   ```bash
   npm pack --dry-run
   ```
   Verify output includes:
   - build/index.js (entry point)
   - package.json with bin field
   - No unnecessary files (tests, coverage, etc.)

If any issues found, fix them in this task. The goal is QUAL-01, QUAL-02, QUAL-03 to pass.
  </action>
  <verify>`npm run lint && npm run test:coverage && npm run build` all pass without errors</verify>
  <done>All quality gates passing: no lint errors, >80% coverage, clean build</done>
</task>

</tasks>

<verification>
- [ ] `npm run lint` passes with no errors (warnings acceptable)
- [ ] `npm run test:coverage` passes with all thresholds > 80%
- [ ] `npm run build` completes without TypeScript errors
- [ ] `npm pack --dry-run` shows expected package contents
- [ ] eslint, @eslint/js, typescript-eslint in devDependencies
- [ ] @vitest/coverage-v8 in devDependencies
- [ ] eslint.config.mjs exists with TypeScript configuration
- [ ] vitest.config.ts has coverage thresholds configured
</verification>

<success_criteria>
QUAL-01: Test coverage > 80% for all metrics
QUAL-02: No TypeScript errors or ESLint warnings
QUAL-03: Response time < 2s for simple operations (verified by existing tests)
QUAL-04: Package installable via npx (validated by npm pack)
All quality gates automated and passing
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features-polish/06-06-SUMMARY.md`
</output>
