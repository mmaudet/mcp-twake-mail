---
phase: 06-advanced-features-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - src/cli/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `npx mcp-twake-mail` with no args starts MCP server"
    - "Running `npx mcp-twake-mail --version` shows version"
    - "Running `npx mcp-twake-mail --help` shows available commands"
    - "CLI uses Commander.js with Git-style subcommands"
  artifacts:
    - path: "src/cli/index.ts"
      provides: "CLI entry point with Commander.js setup"
      exports: ["runCLI"]
    - path: "src/index.ts"
      provides: "Entry point router (CLI vs MCP server)"
      contains: "commander"
    - path: "package.json"
      provides: "CLI dependencies"
      contains: "commander"
  key_links:
    - from: "src/index.ts"
      to: "src/cli/index.ts"
      via: "Dynamic import for CLI commands"
      pattern: "import.*cli"
    - from: "src/index.ts"
      to: "src/mcp/server.ts"
      via: "startServer for MCP mode"
      pattern: "startServer"
---

<objective>
Set up CLI foundation with Commander.js for subcommand routing (setup, auth, check).

Purpose: Transform the entry point from MCP-only to a CLI router that can either start the MCP server (default, no args) or run interactive CLI commands (setup, auth, check). This enables user-friendly configuration without requiring manual environment variable setup.

Output: CLI entry point using Commander.js with version/help commands working, MCP server as default action.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-advanced-features-polish/06-RESEARCH.md

# Existing code to modify
@src/index.ts - Current entry point (will become CLI router)
@src/mcp/server.ts - MCP server startup (called as default action)
@package.json - Add commander dependency
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Commander.js and Create CLI Module</name>
  <files>package.json, src/cli/index.ts</files>
  <action>
1. Install Commander.js:
   ```bash
   npm install commander
   ```

2. Create src/cli/index.ts with CLI entry point:
   ```typescript
   /**
    * CLI entry point using Commander.js.
    * Routes between MCP server (default) and interactive commands.
    */
   import { Command } from 'commander';
   import { startServer } from '../mcp/server.js';

   // Read version from package.json at runtime to stay in sync
   const VERSION = '0.1.0'; // Match package.json

   /**
    * Create and configure the CLI program.
    * @returns Configured Commander program
    */
   export function createCLI(): Command {
     const program = new Command();

     program
       .name('mcp-twake-mail')
       .description('MCP server for JMAP mail operations via Twake Mail')
       .version(VERSION);

     // Default action: start MCP server (no subcommand)
     program
       .action(async () => {
         await startServer();
       });

     // Placeholder subcommands (implemented in later plans)
     program
       .command('setup')
       .description('Interactive configuration wizard')
       .action(async () => {
         console.error('Setup wizard not yet implemented');
         process.exit(1);
       });

     program
       .command('auth')
       .description('Re-run OIDC authentication')
       .action(async () => {
         console.error('Auth command not yet implemented');
         process.exit(1);
       });

     program
       .command('check')
       .description('Verify configuration and test connection')
       .action(async () => {
         console.error('Check command not yet implemented');
         process.exit(1);
       });

     return program;
   }

   /**
    * Run the CLI program.
    * Uses parseAsync for proper async action handling.
    */
   export async function runCLI(): Promise<void> {
     const program = createCLI();
     await program.parseAsync(process.argv);
   }
   ```

Note: Placeholder commands will be implemented in Plans 04 and 05.
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>Commander.js installed and CLI module created with placeholder subcommands</done>
</task>

<task type="auto">
  <name>Task 2: Update Entry Point to Use CLI Router</name>
  <files>src/index.ts</files>
  <action>
Replace src/index.ts with CLI router:

```typescript
#!/usr/bin/env node
/**
 * Entry point for mcp-twake-mail.
 * Routes to CLI commands or MCP server based on arguments.
 */
import { runCLI } from './cli/index.js';

runCLI().catch((error) => {
  // Log to stderr (NEVER stdout - may be reserved for MCP JSON-RPC)
  process.stderr.write(`Fatal error: ${error instanceof Error ? error.message : String(error)}\n`);
  process.exit(1);
});
```

This is cleaner than the previous version - all CLI logic is now in cli/index.ts.
The default action (no args) calls startServer(), preserving MCP behavior.
  </action>
  <verify>`npm run build` succeeds and `node build/index.js --version` shows version</verify>
  <done>Entry point routes through CLI, default action starts MCP server</done>
</task>

<task type="auto">
  <name>Task 3: Verify CLI Behavior</name>
  <files>None (verification only)</files>
  <action>
Test CLI behavior after build:

1. Version command:
   ```bash
   node build/index.js --version
   # Should output: 0.1.0
   ```

2. Help command:
   ```bash
   node build/index.js --help
   # Should show: mcp-twake-mail with description and commands (setup, auth, check)
   ```

3. Subcommand help:
   ```bash
   node build/index.js setup --help
   # Should show: Interactive configuration wizard
   ```

4. Unknown command:
   ```bash
   node build/index.js unknown 2>&1 || true
   # Should show error about unknown command
   ```

5. Default behavior (no args) - don't run fully since it needs JMAP env vars:
   - Verify it attempts to start server (may fail with config error, that's expected)
  </action>
  <verify>All CLI commands respond correctly (--version, --help, subcommand --help)</verify>
  <done>CLI foundation working with version, help, and subcommand structure</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` completes without errors
- [ ] `npm test` passes (existing tests unaffected)
- [ ] `node build/index.js --version` outputs "0.1.0"
- [ ] `node build/index.js --help` shows description and commands
- [ ] `node build/index.js setup --help` shows setup description
- [ ] commander is in package.json dependencies
</verification>

<success_criteria>
CLI-01: Package provides CLI via `npx mcp-twake-mail`
CLI-02: --version flag works
CLI-03: --help flag shows available commands
CLI foundation ready for setup wizard and auth/check commands in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features-polish/06-03-SUMMARY.md`
</output>
