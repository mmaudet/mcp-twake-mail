---
phase: 06-advanced-features-polish
plan: 04
type: execute
wave: 2
depends_on: ["06-03"]
files_modified:
  - src/cli/commands/setup.ts
  - src/cli/prompts/setup-wizard.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "User can run interactive setup wizard via CLI"
    - "Wizard prompts for JMAP URL, auth method, and auth-specific fields"
    - "Wizard tests connection before generating config"
    - "Wizard generates Claude Desktop config JSON"
    - "Wizard offers to write config to Claude Desktop location"
  artifacts:
    - path: "src/cli/commands/setup.ts"
      provides: "Setup command handler"
      exports: ["runSetup"]
    - path: "src/cli/prompts/setup-wizard.ts"
      provides: "Interactive prompt functions"
      exports: ["promptJmapUrl", "promptAuthMethod", "promptBasicAuth", "promptOidcAuth"]
  key_links:
    - from: "src/cli/commands/setup.ts"
      to: "src/cli/prompts/setup-wizard.ts"
      via: "Imports prompt functions for wizard flow"
      pattern: "import.*setup-wizard"
    - from: "src/cli/index.ts"
      to: "src/cli/commands/setup.ts"
      via: "Dynamic import for setup command"
      pattern: "import.*commands/setup"
---

<objective>
Implement interactive setup wizard using @inquirer/prompts that generates Claude Desktop config.

Purpose: Provide user-friendly initial configuration without requiring manual environment variable setup. The wizard guides users through JMAP URL, authentication method selection, and credential entry, then generates ready-to-use Claude Desktop config JSON.

Output: Complete setup wizard command that prompts for configuration, tests the connection, and outputs/writes Claude Desktop config.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-advanced-features-polish/06-RESEARCH.md

# Existing code
@src/cli/index.ts - CLI entry point (update setup command)
@src/config/schema.ts - Config validation (reference for fields)
@src/jmap/client.ts - For connection testing
@src/auth/oidc-flow.ts - OIDC flow for auth testing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Inquirer and Create Prompt Functions</name>
  <files>package.json, src/cli/prompts/setup-wizard.ts</files>
  <action>
1. Install @inquirer/prompts:
   ```bash
   npm install @inquirer/prompts
   ```

2. Create src/cli/prompts/setup-wizard.ts with prompt functions:

```typescript
/**
 * Interactive prompts for setup wizard.
 * Uses @inquirer/prompts for modern, TypeScript-first prompts.
 */
import { input, select, password, confirm } from '@inquirer/prompts';

/** Auth method choices for the wizard */
export type AuthMethod = 'oidc' | 'basic' | 'bearer';

/**
 * Prompt for JMAP session URL with validation.
 */
export async function promptJmapUrl(): Promise<string> {
  return input({
    message: 'JMAP Session URL:',
    default: 'https://jmap.linagora.com/jmap/session',
    validate: (value) => {
      try {
        new URL(value);
        return true;
      } catch {
        return 'Please enter a valid URL';
      }
    },
  });
}

/**
 * Prompt for authentication method selection.
 */
export async function promptAuthMethod(): Promise<AuthMethod> {
  return select({
    message: 'Authentication method:',
    choices: [
      { value: 'oidc' as const, name: 'OIDC (recommended for Twake Mail)' },
      { value: 'basic' as const, name: 'Basic Auth (username/password)' },
      { value: 'bearer' as const, name: 'Bearer Token' },
    ],
  });
}

/**
 * Prompt for Basic auth credentials.
 */
export async function promptBasicAuth(): Promise<{ username: string; password: string }> {
  const username = await input({
    message: 'Username (email):',
    validate: (value) => value.length > 0 || 'Username is required',
  });

  const pwd = await password({
    message: 'Password:',
    mask: '*',
  });

  return { username, password: pwd };
}

/**
 * Prompt for Bearer token.
 */
export async function promptBearerToken(): Promise<string> {
  return password({
    message: 'Bearer token:',
    mask: '*',
    validate: (value) => value.length > 0 || 'Token is required',
  });
}

/**
 * Prompt for OIDC configuration.
 */
export async function promptOidcAuth(): Promise<{
  issuer: string;
  clientId: string;
  scope: string;
}> {
  const issuer = await input({
    message: 'OIDC Issuer URL:',
    default: 'https://auth.linagora.com/auth/realms/Twake',
    validate: (value) => {
      try {
        new URL(value);
        return true;
      } catch {
        return 'Please enter a valid URL';
      }
    },
  });

  const clientId = await input({
    message: 'OAuth Client ID:',
    default: 'twake-mail',
    validate: (value) => value.length > 0 || 'Client ID is required',
  });

  const scope = await input({
    message: 'OAuth Scopes:',
    default: 'openid profile email offline_access',
  });

  return { issuer, clientId, scope };
}

/**
 * Prompt to confirm writing config to file.
 */
export async function promptWriteConfig(): Promise<boolean> {
  return confirm({
    message: 'Write config to Claude Desktop config file?',
    default: true,
  });
}

/**
 * Prompt for custom server name in Claude config.
 */
export async function promptServerName(): Promise<string> {
  return input({
    message: 'Server name in Claude Desktop:',
    default: 'twake-mail',
    validate: (value) => /^[a-z0-9-]+$/.test(value) || 'Use lowercase letters, numbers, and hyphens only',
  });
}
```
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>@inquirer/prompts installed and prompt functions created</done>
</task>

<task type="auto">
  <name>Task 2: Implement Setup Command Handler</name>
  <files>src/cli/commands/setup.ts</files>
  <action>
Create src/cli/commands/setup.ts with the setup wizard flow:

```typescript
/**
 * Setup wizard command - interactive configuration for mcp-twake-mail.
 * Generates Claude Desktop config JSON.
 */
import { homedir } from 'node:os';
import { join } from 'node:path';
import { readFile, writeFile, mkdir } from 'node:fs/promises';

import {
  promptJmapUrl,
  promptAuthMethod,
  promptBasicAuth,
  promptBearerToken,
  promptOidcAuth,
  promptWriteConfig,
  promptServerName,
  type AuthMethod,
} from '../prompts/setup-wizard.js';

/**
 * Get Claude Desktop config file path based on platform.
 */
function getClaudeConfigPath(): string {
  const home = homedir();
  if (process.platform === 'darwin') {
    return join(home, 'Library', 'Application Support', 'Claude', 'claude_desktop_config.json');
  } else if (process.platform === 'win32') {
    return join(process.env.APPDATA || join(home, 'AppData', 'Roaming'), 'Claude', 'claude_desktop_config.json');
  }
  // Linux fallback (unofficial)
  return join(home, '.config', 'claude', 'claude_desktop_config.json');
}

/**
 * Generate Claude Desktop config for this MCP server.
 */
function generateClaudeConfig(
  serverName: string,
  env: Record<string, string>
): { mcpServers: Record<string, { command: string; args: string[]; env: Record<string, string> }> } {
  return {
    mcpServers: {
      [serverName]: {
        command: 'npx',
        args: ['-y', 'mcp-twake-mail'],
        env,
      },
    },
  };
}

/**
 * Test JMAP connection with provided config.
 * Returns true if connection successful, false otherwise.
 */
async function testConnection(env: Record<string, string>): Promise<{ success: boolean; error?: string }> {
  // Dynamically import to avoid loading JMAP client in CLI context unnecessarily
  try {
    const { JMAPClient } = await import('../../jmap/client.js');
    const { createLogger } = await import('../../config/logger.js');

    // Build minimal config object for JMAPClient
    const config = {
      JMAP_SESSION_URL: env.JMAP_SESSION_URL,
      JMAP_AUTH_METHOD: env.JMAP_AUTH_METHOD as 'basic' | 'bearer' | 'oidc',
      JMAP_USERNAME: env.JMAP_USERNAME,
      JMAP_PASSWORD: env.JMAP_PASSWORD,
      JMAP_BEARER_TOKEN: env.JMAP_BEARER_TOKEN,
      JMAP_OIDC_ISSUER: env.JMAP_OIDC_ISSUER,
      JMAP_OIDC_CLIENT_ID: env.JMAP_OIDC_CLIENT_ID,
      JMAP_OIDC_SCOPE: env.JMAP_OIDC_SCOPE || 'openid profile email offline_access',
      JMAP_OIDC_REDIRECT_PORT: 8085,
      JMAP_REQUEST_TIMEOUT_MS: 30000,
      LOG_LEVEL: 'error' as const,
    };

    const logger = createLogger('error');
    const client = new JMAPClient(config, logger);

    // For OIDC, we need to run the auth flow first
    if (config.JMAP_AUTH_METHOD === 'oidc') {
      const { performOIDCFlow } = await import('../../auth/oidc-flow.js');
      console.log('\nOpening browser for authentication...');
      await performOIDCFlow({
        issuerUrl: config.JMAP_OIDC_ISSUER!,
        clientId: config.JMAP_OIDC_CLIENT_ID!,
        scope: config.JMAP_OIDC_SCOPE,
        redirectPort: config.JMAP_OIDC_REDIRECT_PORT,
      });
      console.log('Authentication successful!\n');
    }

    const session = await client.fetchSession();
    console.log(`Connected! Account ID: ${session.accountId}`);
    return { success: true };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : String(error),
    };
  }
}

/**
 * Run the interactive setup wizard.
 */
export async function runSetup(): Promise<void> {
  console.log('\n=== MCP Twake Mail Setup Wizard ===\n');

  // Step 1: JMAP URL
  const jmapUrl = await promptJmapUrl();

  // Step 2: Auth method
  const authMethod = await promptAuthMethod();

  // Step 3: Auth-specific prompts
  const env: Record<string, string> = {
    JMAP_SESSION_URL: jmapUrl,
    JMAP_AUTH_METHOD: authMethod,
  };

  if (authMethod === 'basic') {
    const { username, password } = await promptBasicAuth();
    env.JMAP_USERNAME = username;
    env.JMAP_PASSWORD = password;
  } else if (authMethod === 'bearer') {
    env.JMAP_BEARER_TOKEN = await promptBearerToken();
  } else if (authMethod === 'oidc') {
    const { issuer, clientId, scope } = await promptOidcAuth();
    env.JMAP_OIDC_ISSUER = issuer;
    env.JMAP_OIDC_CLIENT_ID = clientId;
    env.JMAP_OIDC_SCOPE = scope;
  }

  // Step 4: Test connection
  console.log('\nTesting connection...');
  const testResult = await testConnection(env);

  if (!testResult.success) {
    console.error(`\nConnection failed: ${testResult.error}`);
    console.error('Please check your configuration and try again.\n');
    process.exit(1);
  }

  console.log('\nConnection successful!\n');

  // Step 5: Server name for Claude config
  const serverName = await promptServerName();

  // Step 6: Generate config
  const config = generateClaudeConfig(serverName, env);
  const configJson = JSON.stringify(config, null, 2);

  console.log('\n--- Generated Claude Desktop Config ---');
  console.log(configJson);
  console.log('---------------------------------------\n');

  // Step 7: Optionally write to Claude Desktop config
  const shouldWrite = await promptWriteConfig();

  if (shouldWrite) {
    const configPath = getClaudeConfigPath();
    console.log(`\nWriting to: ${configPath}`);

    try {
      // Read existing config if it exists
      let existingConfig: Record<string, unknown> = {};
      try {
        const existingContent = await readFile(configPath, 'utf-8');
        existingConfig = JSON.parse(existingContent);
      } catch {
        // File doesn't exist or is invalid, start fresh
      }

      // Merge mcpServers
      const mergedConfig = {
        ...existingConfig,
        mcpServers: {
          ...(existingConfig.mcpServers as Record<string, unknown> || {}),
          ...config.mcpServers,
        },
      };

      // Ensure directory exists
      await mkdir(join(configPath, '..'), { recursive: true });

      // Write merged config
      await writeFile(configPath, JSON.stringify(mergedConfig, null, 2), 'utf-8');
      console.log('Config written successfully!');
      console.log('\nRestart Claude Desktop to load the new configuration.\n');
    } catch (error) {
      console.error(`Failed to write config: ${error instanceof Error ? error.message : String(error)}`);
      console.error('\nYou can manually add the config above to your Claude Desktop configuration.\n');
      process.exit(1);
    }
  } else {
    console.log('\nTo use this configuration, add it to your Claude Desktop config file:');
    console.log(`  ${getClaudeConfigPath()}\n`);
  }
}
```
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>Setup command handler implemented with wizard flow</done>
</task>

<task type="auto">
  <name>Task 3: Wire Setup Command to CLI</name>
  <files>src/cli/index.ts</files>
  <action>
Update src/cli/index.ts to use real setup command:

Replace the placeholder setup command action with dynamic import:

```typescript
program
  .command('setup')
  .description('Interactive configuration wizard')
  .action(async () => {
    const { runSetup } = await import('./commands/setup.js');
    await runSetup();
  });
```

The dynamic import ensures CLI prompts are only loaded when the setup command is used,
keeping the MCP server path lightweight.
  </action>
  <verify>`npm run build` succeeds and `node build/index.js setup --help` shows setup description</verify>
  <done>Setup command wired to CLI router</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` completes without errors
- [ ] `npm test` passes (existing tests unaffected)
- [ ] `node build/index.js setup --help` shows "Interactive configuration wizard"
- [ ] @inquirer/prompts is in package.json dependencies
- [ ] src/cli/prompts/setup-wizard.ts exists with prompt functions
- [ ] src/cli/commands/setup.ts exists with runSetup()
</verification>

<success_criteria>
CLI-04: Setup wizard prompts for JMAP URL
CLI-05: Setup wizard prompts for auth method (oidc/basic/bearer)
CLI-06: Setup wizard prompts for auth-specific fields
CLI-07: Setup wizard tests connection before generating config
CLI-08: Setup wizard generates Claude Desktop config JSON
CLI-09: Setup wizard offers to write config to Claude Desktop location
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features-polish/06-04-SUMMARY.md`
</output>
