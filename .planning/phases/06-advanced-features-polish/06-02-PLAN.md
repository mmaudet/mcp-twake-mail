---
phase: 06-advanced-features-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp/tools/attachment.ts
  - src/mcp/tools/attachment.test.ts
  - src/mcp/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "AI assistant can list all attachments for an email with metadata"
    - "Attachments include blobId, name, type, size, and isInline flag"
    - "Attachments can be filtered by excludeInline and mimeTypeFilter"
  artifacts:
    - path: "src/mcp/tools/attachment.ts"
      provides: "Attachment MCP tool (get_attachments)"
      exports: ["registerAttachmentTools"]
    - path: "src/mcp/tools/attachment.test.ts"
      provides: "Unit tests for attachment tool"
      min_lines: 60
  key_links:
    - from: "src/mcp/tools/attachment.ts"
      to: "jmapClient.request"
      via: "Email/get with attachments and bodyProperties"
      pattern: "Email/get.*attachments"
    - from: "src/mcp/tools/index.ts"
      to: "src/mcp/tools/attachment.ts"
      via: "registerAttachmentTools import and call"
      pattern: "registerAttachmentTools"
---

<objective>
Implement attachment metadata retrieval MCP tool (get_attachments) using JMAP Email/get with bodyProperties.

Purpose: Enable AI assistants to list and filter email attachments without downloading the actual content. This supports attachment-aware responses like "You have 3 PDF attachments" or "There's an image embedded inline."

Output: One new MCP tool - get_attachments returns attachment metadata with isInline detection and optional filtering.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-advanced-features-polish/06-RESEARCH.md

# Existing patterns
@src/mcp/tools/email.ts - Follow this pattern for tool registration
@src/mcp/tools/index.ts - Add attachment tool to aggregator
@src/jmap/client.ts - JMAP client for requests
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Attachment MCP Tool</name>
  <files>src/mcp/tools/attachment.ts</files>
  <action>
Create attachment.ts following the pattern from email.ts:

1. Define AttachmentMetadata interface:
   ```typescript
   interface AttachmentMetadata {
     blobId: string;
     name: string | null;
     type: string;
     size: number;
     isInline: boolean;
   }
   ```

2. Add ATTACHMENT_READ_ANNOTATIONS constant (same as EMAIL_READ_ANNOTATIONS)

3. Implement isInline detection function per RFC 8621:
   ```typescript
   // isInline = has cid AND disposition !== 'attachment'
   function isInlineAttachment(part: { cid?: string; disposition?: string }): boolean {
     return !!part.cid && part.disposition !== 'attachment';
   }
   ```

4. Implement get_attachments tool:
   - Inputs:
     * emailId (string, required) - Email to get attachments from
     * excludeInline (boolean, optional, default false) - Exclude inline attachments
     * mimeTypeFilter (string, optional) - Filter by MIME type prefix (e.g., "image/", "application/pdf")
   - JMAP call: Email/get with properties: ['attachments'], bodyProperties: ['blobId', 'name', 'type', 'size', 'disposition', 'cid']
   - Transform each attachment to AttachmentMetadata with isInline
   - Apply filters after transformation
   - Return: { emailId, attachments: AttachmentMetadata[], total: number (before filtering), filtered: number (after filtering) }

5. Export registerAttachmentTools(server, jmapClient, logger) function

Handle email not found and empty attachments (return empty array, not error).
  </action>
  <verify>TypeScript compiles: `npm run build`</verify>
  <done>get_attachments tool implemented with isInline detection and filtering</done>
</task>

<task type="auto">
  <name>Task 2: Register Attachment Tool and Add Tests</name>
  <files>src/mcp/tools/index.ts, src/mcp/tools/attachment.test.ts</files>
  <action>
1. Update src/mcp/tools/index.ts:
   - Import registerAttachmentTools from './attachment.js'
   - Call registerAttachmentTools(server, jmapClient, logger) in registerAllTools()
   - Add comment: "Register attachment tools (get_attachments)"

2. Create src/mcp/tools/attachment.test.ts with unit tests:
   - Mock JMAPClient.request() and parseMethodResponse()
   - Test get_attachments:
     * Success with multiple attachments (mix of inline and regular)
     * Email with no attachments: returns empty array
     * Email not found: returns isError with message
   - Test isInline detection:
     * has cid + disposition=null -> isInline=true
     * has cid + disposition='inline' -> isInline=true
     * has cid + disposition='attachment' -> isInline=false
     * no cid -> isInline=false
   - Test excludeInline filter:
     * When true, inline attachments removed
     * When false (default), all attachments returned
   - Test mimeTypeFilter:
     * "image/" filters to only image/* types
     * "application/pdf" filters to exact match
     * No filter returns all
   - Test combined filters (excludeInline + mimeTypeFilter)
  </action>
  <verify>`npm test` passes with attachment tool tests</verify>
  <done>Attachment tool integrated in index.ts and has comprehensive unit tests</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` completes without errors
- [ ] `npm test` passes all tests including new attachment tests
- [ ] get_attachments tool exists with emailId, excludeInline, mimeTypeFilter inputs
- [ ] AttachmentMetadata includes blobId, name, type, size, isInline
- [ ] Filtering works correctly for both excludeInline and mimeTypeFilter
- [ ] Attachment tool registered in registerAllTools()
</verification>

<success_criteria>
ATTACH-01: get_attachments tool lists attachment metadata (blobId, name, type, size, isInline)
ATTACH-02: Attachments filtered by excludeInline and mimeTypeFilter parameters
Tool follows established error handling patterns and has unit test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features-polish/06-02-SUMMARY.md`
</output>
