---
phase: 06-advanced-features-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp/tools/thread.ts
  - src/mcp/tools/thread.test.ts
  - src/mcp/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "AI assistant can retrieve a thread by ID with its email list"
    - "AI assistant can get all emails in a thread with full content"
    - "Thread emailIds are returned in oldest-first order (per RFC 8621)"
  artifacts:
    - path: "src/mcp/tools/thread.ts"
      provides: "Thread MCP tools (get_thread, get_thread_emails)"
      exports: ["registerThreadTools"]
    - path: "src/mcp/tools/thread.test.ts"
      provides: "Unit tests for thread tools"
      min_lines: 80
  key_links:
    - from: "src/mcp/tools/thread.ts"
      to: "jmapClient.request"
      via: "Thread/get and Email/get JMAP methods"
      pattern: "Thread/get|Email/get"
    - from: "src/mcp/tools/index.ts"
      to: "src/mcp/tools/thread.ts"
      via: "registerThreadTools import and call"
      pattern: "registerThreadTools"
---

<objective>
Implement thread retrieval MCP tools (get_thread, get_thread_emails) using JMAP Thread/get.

Purpose: Enable AI assistants to navigate email conversations by retrieving thread metadata and all emails within a thread. This is essential for understanding email context and composing contextual replies.

Output: Two new MCP tools - get_thread returns thread ID and emailIds, get_thread_emails returns full email content for all emails in a thread.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-advanced-features-polish/06-RESEARCH.md

# Existing patterns
@src/mcp/tools/email.ts - Follow this pattern for tool registration
@src/mcp/tools/index.ts - Add thread tools to aggregator
@src/jmap/client.ts - JMAP client for requests
@src/transformers/email.ts - Email transformation pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Thread MCP Tools</name>
  <files>src/mcp/tools/thread.ts</files>
  <action>
Create thread.ts following the pattern from email.ts:

1. Add THREAD_READ_ANNOTATIONS constant (same as EMAIL_READ_ANNOTATIONS - readOnlyHint: true, destructiveHint: false, idempotentHint: true, openWorldHint: true)

2. Implement get_thread tool:
   - Input: threadId (string)
   - JMAP call: Thread/get with ids: [threadId]
   - Return: { id, emailIds } where emailIds is sorted oldest-first (per RFC 8621)
   - Handle notFound error with friendly message

3. Implement get_thread_emails tool:
   - Input: threadId (string)
   - Two-step pattern:
     a. Thread/get to get emailIds
     b. Email/get with those IDs and FULL_EMAIL_PROPERTIES
   - Transform emails using transformEmail()
   - Return: { threadId, emails: SimplifiedEmail[] }
   - Emails remain in oldest-first order

4. Export registerThreadTools(server, jmapClient, logger) function

Use the same error handling pattern as email.ts (isError: true with descriptive messages).
  </action>
  <verify>TypeScript compiles: `npm run build`</verify>
  <done>get_thread and get_thread_emails tools implemented with proper JMAP calls and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Register Thread Tools and Add Tests</name>
  <files>src/mcp/tools/index.ts, src/mcp/tools/thread.test.ts</files>
  <action>
1. Update src/mcp/tools/index.ts:
   - Import registerThreadTools from './thread.js'
   - Call registerThreadTools(server, jmapClient, logger) in registerAllTools()
   - Add comment: "Register thread tools (get_thread, get_thread_emails)"

2. Create src/mcp/tools/thread.test.ts with unit tests:
   - Mock JMAPClient.request() and parseMethodResponse()
   - Test get_thread:
     * Success case: returns thread with emailIds array
     * Thread not found: returns isError with message
     * JMAP error: returns isError with description
   - Test get_thread_emails:
     * Success case: returns array of transformed emails
     * Thread not found: returns isError
     * Empty emailIds: returns empty array (not error)
   - Verify emailIds order is preserved (oldest-first)
   - Test error propagation from Email/get after successful Thread/get
  </action>
  <verify>`npm test` passes with thread tool tests</verify>
  <done>Thread tools integrated in index.ts and have comprehensive unit tests</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` completes without errors
- [ ] `npm test` passes all tests including new thread tests
- [ ] get_thread tool exists and handles threadId input
- [ ] get_thread_emails tool exists and returns full email content
- [ ] Thread tools registered in registerAllTools()
</verification>

<success_criteria>
THREAD-01: get_thread tool retrieves thread by ID returning { id, emailIds }
THREAD-02: get_thread_emails tool returns all emails in a thread as SimplifiedEmail[]
Both tools follow established error handling patterns and have unit test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features-polish/06-01-SUMMARY.md`
</output>
