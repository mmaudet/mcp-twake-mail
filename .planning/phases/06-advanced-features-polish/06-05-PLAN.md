---
phase: 06-advanced-features-polish
plan: 05
type: execute
wave: 2
depends_on: ["06-03"]
files_modified:
  - src/cli/commands/auth.ts
  - src/cli/commands/check.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "User can re-run OIDC auth via `npx mcp-twake-mail auth`"
    - "User can verify config and connection via `npx mcp-twake-mail check`"
    - "Check command shows config status (env vars set, connection success)"
  artifacts:
    - path: "src/cli/commands/auth.ts"
      provides: "Auth command handler for OIDC re-authentication"
      exports: ["runAuth"]
    - path: "src/cli/commands/check.ts"
      provides: "Check command handler for config verification"
      exports: ["runCheck"]
  key_links:
    - from: "src/cli/commands/auth.ts"
      to: "src/auth/oidc-flow.ts"
      via: "performOIDCFlow for re-authentication"
      pattern: "performOIDCFlow"
    - from: "src/cli/commands/check.ts"
      to: "src/jmap/client.ts"
      via: "JMAPClient.fetchSession for connection test"
      pattern: "fetchSession"
    - from: "src/cli/index.ts"
      to: "src/cli/commands/auth.ts"
      via: "Dynamic import for auth command"
      pattern: "import.*commands/auth"
---

<objective>
Implement auth and check CLI commands for OIDC re-authentication and config verification.

Purpose: The auth command allows users to refresh OIDC tokens without running the full setup wizard. The check command verifies that configuration is complete and the connection works, helping users diagnose issues.

Output: Two CLI commands - auth re-runs OIDC flow, check verifies config and tests connection.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-advanced-features-polish/06-RESEARCH.md

# Existing code
@src/cli/index.ts - CLI entry point (update auth and check commands)
@src/config/schema.ts - Config schema for validation
@src/auth/oidc-flow.ts - OIDC flow for auth command
@src/jmap/client.ts - JMAP client for connection testing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Auth Command</name>
  <files>src/cli/commands/auth.ts</files>
  <action>
Create src/cli/commands/auth.ts for OIDC re-authentication:

```typescript
/**
 * Auth command - re-run OIDC authentication flow.
 * Useful when tokens have expired or been revoked.
 */
import { loadConfig } from '../../config/schema.js';
import { performOIDCFlow, getOIDCOptionsFromConfig } from '../../auth/oidc-flow.js';

/**
 * Run OIDC authentication flow using current environment config.
 * Requires JMAP_AUTH_METHOD=oidc and OIDC env vars to be set.
 */
export async function runAuth(): Promise<void> {
  console.log('\n=== MCP Twake Mail - Re-authenticate ===\n');

  // Load config from environment
  let config;
  try {
    config = loadConfig();
  } catch (error) {
    console.error('Configuration error:', error instanceof Error ? error.message : String(error));
    console.error('\nMake sure environment variables are set. Run `mcp-twake-mail setup` to configure.');
    process.exit(1);
  }

  // Check if OIDC is configured
  const oidcOptions = getOIDCOptionsFromConfig(config);
  if (!oidcOptions) {
    console.error('OIDC is not configured.');
    console.error('\nThis command only works when JMAP_AUTH_METHOD=oidc');
    console.error('For basic or bearer auth, credentials are read from environment variables.');
    process.exit(1);
  }

  console.log(`Issuer: ${oidcOptions.issuerUrl}`);
  console.log(`Client ID: ${oidcOptions.clientId}`);
  console.log(`Scopes: ${oidcOptions.scope}`);
  console.log('\nOpening browser for authentication...\n');

  try {
    const tokens = await performOIDCFlow(oidcOptions);
    console.log('\nAuthentication successful!');
    console.log(`Access token stored (expires: ${tokens.expiresAt ? new Date(tokens.expiresAt * 1000).toISOString() : 'unknown'})`);
    if (tokens.refreshToken) {
      console.log('Refresh token stored for automatic renewal.');
    }
    console.log('\nYou can now use mcp-twake-mail.\n');
  } catch (error) {
    console.error('\nAuthentication failed:', error instanceof Error ? error.message : String(error));
    process.exit(1);
  }
}
```
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>Auth command implemented for OIDC re-authentication</done>
</task>

<task type="auto">
  <name>Task 2: Implement Check Command</name>
  <files>src/cli/commands/check.ts</files>
  <action>
Create src/cli/commands/check.ts for configuration verification:

```typescript
/**
 * Check command - verify configuration and test connection.
 * Helps users diagnose configuration issues.
 */
import { loadConfig } from '../../config/schema.js';
import { createLogger } from '../../config/logger.js';
import { JMAPClient } from '../../jmap/client.js';

interface CheckResult {
  name: string;
  status: 'ok' | 'warning' | 'error';
  message: string;
}

/**
 * Format check result with status indicator.
 */
function formatResult(result: CheckResult): string {
  const icons = { ok: '[OK]', warning: '[WARN]', error: '[FAIL]' };
  return `${icons[result.status]} ${result.name}: ${result.message}`;
}

/**
 * Check environment configuration.
 */
function checkEnvironment(): CheckResult[] {
  const results: CheckResult[] = [];

  // Check JMAP URL
  const jmapUrl = process.env.JMAP_SESSION_URL;
  if (jmapUrl) {
    results.push({ name: 'JMAP URL', status: 'ok', message: jmapUrl });
  } else {
    results.push({ name: 'JMAP URL', status: 'error', message: 'JMAP_SESSION_URL not set' });
  }

  // Check auth method
  const authMethod = process.env.JMAP_AUTH_METHOD;
  if (authMethod) {
    results.push({ name: 'Auth Method', status: 'ok', message: authMethod });

    // Check auth-specific vars
    if (authMethod === 'basic') {
      const hasUser = !!process.env.JMAP_USERNAME;
      const hasPass = !!process.env.JMAP_PASSWORD;
      if (hasUser && hasPass) {
        results.push({ name: 'Basic Auth', status: 'ok', message: 'Credentials configured' });
      } else {
        results.push({
          name: 'Basic Auth',
          status: 'error',
          message: `Missing: ${!hasUser ? 'JMAP_USERNAME' : ''} ${!hasPass ? 'JMAP_PASSWORD' : ''}`.trim(),
        });
      }
    } else if (authMethod === 'bearer') {
      if (process.env.JMAP_BEARER_TOKEN) {
        results.push({ name: 'Bearer Token', status: 'ok', message: 'Token configured' });
      } else {
        results.push({ name: 'Bearer Token', status: 'error', message: 'JMAP_BEARER_TOKEN not set' });
      }
    } else if (authMethod === 'oidc') {
      const hasIssuer = !!process.env.JMAP_OIDC_ISSUER;
      const hasClient = !!process.env.JMAP_OIDC_CLIENT_ID;
      if (hasIssuer && hasClient) {
        results.push({ name: 'OIDC Config', status: 'ok', message: `Issuer: ${process.env.JMAP_OIDC_ISSUER}` });
      } else {
        results.push({
          name: 'OIDC Config',
          status: 'error',
          message: `Missing: ${!hasIssuer ? 'JMAP_OIDC_ISSUER' : ''} ${!hasClient ? 'JMAP_OIDC_CLIENT_ID' : ''}`.trim(),
        });
      }
    }
  } else {
    results.push({ name: 'Auth Method', status: 'error', message: 'JMAP_AUTH_METHOD not set' });
  }

  return results;
}

/**
 * Test JMAP connection.
 */
async function checkConnection(): Promise<CheckResult> {
  try {
    const config = loadConfig();
    const logger = createLogger('error');
    const client = new JMAPClient(config, logger);

    const session = await client.fetchSession();
    return {
      name: 'Connection',
      status: 'ok',
      message: `Connected (Account: ${session.accountId})`,
    };
  } catch (error) {
    return {
      name: 'Connection',
      status: 'error',
      message: error instanceof Error ? error.message : String(error),
    };
  }
}

/**
 * Run configuration and connection checks.
 */
export async function runCheck(): Promise<void> {
  console.log('\n=== MCP Twake Mail - Configuration Check ===\n');

  // Check environment variables
  console.log('Environment Configuration:');
  const envResults = checkEnvironment();
  for (const result of envResults) {
    console.log(`  ${formatResult(result)}`);
  }

  // Check for configuration errors
  const hasEnvError = envResults.some((r) => r.status === 'error');
  if (hasEnvError) {
    console.log('\nConfiguration incomplete. Run `mcp-twake-mail setup` to configure.\n');
    process.exit(1);
  }

  // Test connection
  console.log('\nConnection Test:');
  const connResult = await checkConnection();
  console.log(`  ${formatResult(connResult)}`);

  if (connResult.status === 'error') {
    console.log('\nConnection failed. Check your configuration and network.\n');
    process.exit(1);
  }

  console.log('\nAll checks passed! mcp-twake-mail is ready to use.\n');
}
```
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>Check command implemented for config verification and connection testing</done>
</task>

<task type="auto">
  <name>Task 3: Wire Auth and Check Commands to CLI</name>
  <files>src/cli/index.ts</files>
  <action>
Update src/cli/index.ts to use real auth and check commands:

Replace the placeholder auth command action:
```typescript
program
  .command('auth')
  .description('Re-run OIDC authentication')
  .action(async () => {
    const { runAuth } = await import('./commands/auth.js');
    await runAuth();
  });
```

Replace the placeholder check command action:
```typescript
program
  .command('check')
  .description('Verify configuration and test connection')
  .action(async () => {
    const { runCheck } = await import('./commands/check.js');
    await runCheck();
  });
```

Dynamic imports ensure these commands only load their dependencies when called.
  </action>
  <verify>`npm run build` succeeds and both `auth --help` and `check --help` work</verify>
  <done>Auth and check commands wired to CLI router</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` completes without errors
- [ ] `npm test` passes (existing tests unaffected)
- [ ] `node build/index.js auth --help` shows "Re-run OIDC authentication"
- [ ] `node build/index.js check --help` shows "Verify configuration and test connection"
- [ ] src/cli/commands/auth.ts exists with runAuth()
- [ ] src/cli/commands/check.ts exists with runCheck()
</verification>

<success_criteria>
CLI-10: Auth command re-runs OIDC authentication flow
CLI-11: Check command verifies configuration and tests connection
Both commands handle errors gracefully with helpful messages
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features-polish/06-05-SUMMARY.md`
</output>
